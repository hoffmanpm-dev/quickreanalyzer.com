<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="RE Analyzer">
<title>Quick Real Estate Analyzer</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Helvetica Neue',sans-serif;background:#F3F4F6;min-height:100vh;max-width:480px;margin:0 auto;cursor:pointer}
.header{background:linear-gradient(135deg,#1E40AF,#3B82F6);padding:24px 20px 18px;border-radius:0 0 24px 24px;color:#fff;position:sticky;top:0;z-index:10}
.header h1{font-size:21px;font-weight:800;letter-spacing:-0.5px}
.header p{font-size:12px;opacity:0.8;margin-top:2px}
.content{padding:16px 16px 60px}
.section{margin-bottom:16px}
.sec-btn{display:flex;justify-content:space-between;align-items:center;width:100%;padding:10px 0;background:none;border:none;cursor:pointer;-webkit-appearance:none;appearance:none;font-family:inherit;touch-action:manipulation}
.sec-btn span:first-child{font-size:15px;font-weight:700;color:#1F2937}
.arrow{font-size:18px;color:#9CA3AF;transition:transform 0.2s;display:inline-block}
.sec-body{overflow:hidden;max-height:0;transition:max-height 0.3s ease}
.sec-body.open{max-height:8000px}
.field{margin-bottom:12px}
.field label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:4px}
.help{font-weight:400;color:#9CA3AF;margin-left:6px;font-size:11px}
.iw{display:flex;align-items:center;border:1px solid #D1D5DB;border-radius:10px;overflow:hidden;background:#fff}
.iw .pre{padding:8px 0 8px 12px;color:#9CA3AF;font-size:15px;user-select:none}
.iw input[type="number"],.iw input[type="text"]{flex:1;border:none;outline:none;padding:10px 8px;font-size:16px;background:transparent;width:100%;min-width:0;-webkit-appearance:none;appearance:none;border-radius:0}
.iw .suf{padding:8px 12px 8px 0;color:#9CA3AF;font-size:13px;user-select:none;white-space:nowrap}
.tog-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.tog-row span{font-size:13px;font-weight:600;color:#374151}
.tog-btn{width:48px;height:28px;border-radius:14px;padding:2px;cursor:pointer;background:#D1D5DB;transition:background 0.2s;position:relative;flex-shrink:0;border:none;-webkit-appearance:none;appearance:none;touch-action:manipulation}
.tog-btn.on{background:#2563EB}
.tog-k{width:24px;height:24px;border-radius:12px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);transition:transform 0.2s;pointer-events:none}
.tog-btn.on .tog-k{transform:translateX(20px)}
.hm-fields{display:none}.hm-fields.show{display:block}
.action-btn{display:block;width:100%;color:#fff;text-align:center;padding:14px 20px;border-radius:12px;cursor:pointer;font-weight:700;font-size:14px;font-family:inherit;margin-bottom:12px;border:none;-webkit-appearance:none;appearance:none;touch-action:manipulation}
.calc-btn{background:#059669;box-shadow:0 2px 8px rgba(5,150,105,0.3)}.calc-btn:active{background:#047857}
.pf-btn{background:#1E40AF;box-shadow:0 2px 8px rgba(30,64,175,0.3)}.pf-btn:active{background:#1E3A8A}
.dl-btn{background:#7C3AED;box-shadow:0 2px 8px rgba(124,58,237,0.3)}.dl-btn:active{background:#6D28D9}
.sa-btn{background:#D97706;box-shadow:0 2px 8px rgba(217,119,6,0.3)}.sa-btn:active{background:#B45309}
.mg{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px}
.mc{background:#fff;border-radius:14px;padding:16px 14px;flex:1 1 45%;min-width:140px;box-shadow:0 1px 3px rgba(0,0,0,0.08);border:1px solid #E5E7EB}
.ml{font-size:12px;color:#6B7280;font-weight:500;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
.mv{font-size:22px;font-weight:700}
.ms{font-size:11px;color:#9CA3AF;margin-top:2px}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);border:1px solid #E5E7EB}
.ct{font-size:14px;font-weight:700;color:#1F2937;margin-bottom:10px}
.row{display:flex;justify-content:space-between;font-size:13px;color:#4B5563;line-height:1.8}
.row .v{font-weight:600}
.divr{border-top:1px solid #E5E7EB;padding-top:6px;margin-top:6px}
.hlr{display:flex;justify-content:space-between;background:#EFF6FF;margin:8px -16px -16px;padding:10px 16px;border-radius:0 0 14px 14px;font-weight:700;font-size:14px;color:#1E40AF}
.pfw{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:620px}
th{padding:8px 6px;text-align:right;font-weight:700;color:#374151;white-space:nowrap;border-bottom:2px solid #E5E7EB}
td{padding:6px;text-align:right;border-bottom:1px solid #F3F4F6}
td.yr{text-align:center;font-weight:700;color:#6B7280}
.pfn{font-size:11px;color:#9CA3AF;margin-top:8px;text-align:center}
.grn{color:#059669}.red{color:#DC2626}.blu{color:#1E40AF}.amb{color:#D97706}
#results{display:none}#results.show{display:block}
.unit-card{background:#fff;border:1px solid #E5E7EB;border-radius:10px;padding:12px;margin-bottom:10px}
.unit-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.unit-hdr span{font-size:14px;font-weight:700;color:#1F2937}
.type-toggle{display:flex;border-radius:8px;overflow:hidden;border:1px solid #D1D5DB}
.type-opt{padding:6px 12px;font-size:12px;font-weight:600;cursor:pointer;background:#fff;color:#6B7280;border:none;font-family:inherit;-webkit-appearance:none;appearance:none;touch-action:manipulation}
.type-opt.active{background:#2563EB;color:#fff}
.unit-fields{margin-top:4px}
.unit-fields-row{display:flex;gap:8px}
.unit-fields-row .field{flex:1;margin-bottom:8px}
.unit-stepper{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.step-btn{width:36px;height:36px;border-radius:18px;border:2px solid #D1D5DB;background:#fff;font-size:20px;font-weight:700;color:#374151;cursor:pointer;display:flex;align-items:center;justify-content:center;-webkit-appearance:none;appearance:none;touch-action:manipulation;font-family:inherit;line-height:1}
.step-btn:active{background:#E5E7EB}
.unit-count{font-size:18px;font-weight:700;color:#1F2937;min-width:30px;text-align:center}
.addr-input{width:100%;border:1px solid #D1D5DB;border-radius:10px;padding:10px 12px;font-size:16px;font-family:inherit;background:#fff;-webkit-appearance:none;appearance:none;outline:none}
.addr-input:focus{border-color:#3B82F6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
.rehab-toggle,.strat-tabs{display:flex;border-radius:8px;overflow:hidden;border:1px solid #D1D5DB;margin-bottom:12px}
.rehab-opt{padding:8px 14px;font-size:13px;font-weight:600;cursor:pointer;background:#fff;color:#6B7280;border:none;font-family:inherit;flex:1;text-align:center;-webkit-appearance:none;appearance:none;touch-action:manipulation}
.rehab-opt.active{background:#2563EB;color:#fff}
.strat-tabs{margin-bottom:16px;border:2px solid #1E40AF}
.strat-tab{padding:10px 8px;font-size:13px;font-weight:700;cursor:pointer;background:#fff;color:#6B7280;border:none;font-family:inherit;flex:1;text-align:center;-webkit-appearance:none;appearance:none;touch-action:manipulation;transition:all 0.2s}
.strat-tab.active{background:#1E40AF;color:#fff}
.strat-panel{display:none}.strat-panel.active{display:block}
.sens-tbl{width:100%;border-collapse:collapse;font-size:11px;min-width:auto}
.sens-tbl th{padding:6px 4px;text-align:center;font-size:10px;border-bottom:2px solid #E5E7EB;white-space:nowrap}
.sens-tbl td{padding:5px 4px;text-align:center;border-bottom:1px solid #F3F4F6;font-weight:600}
.sens-tbl td.base{background:#EFF6FF;font-weight:800}
.sens-tbl td:first-child{text-align:left;font-weight:700;color:#6B7280;font-size:10px}
.io-label{font-size:11px;color:#9CA3AF;font-style:italic;margin-top:-4px;margin-bottom:8px}
.str-calc{font-size:12px;color:#059669;font-weight:700;padding:4px 0 4px 0}
.flip-profit{font-size:28px;font-weight:800;text-align:center;margin:8px 0}
.addr-row{display:flex;gap:8px}
.addr-row .field{flex:1;margin-bottom:8px}
.addr-err{border-color:#DC2626 !important;box-shadow:0 0 0 3px rgba(220,38,38,0.15) !important}
.err-msg{font-size:11px;color:#DC2626;font-weight:600;margin-bottom:8px;display:none}
.err-msg.show{display:block}
.req{color:#DC2626;margin-left:2px}
</style>
</head>
<body ontouchstart="">

<div class="header">
  <h1>Quick Real Estate Analyzer</h1>
  <p>Buy &amp; Hold &middot; BRRRR &middot; Flip</p>
</div>

<div class="content">

  <!-- ═══ PROPERTY INFO ═══ -->
  <div class="section">
    <button type="button" class="sec-btn" id="secPropBtn">
      <span>Property Info</span><span class="arrow" id="arrowProp" style="transform:rotate(90deg)">›</span>
    </button>
    <div class="sec-body open" id="secProp">
      <div class="err-msg" id="addrErr">Please fill in all address fields before calculating.</div>
      <div class="field">
        <label>Street Address<span class="req">*</span></label>
        <input type="text" class="addr-input" id="addrStreet" placeholder="123 Main St">
      </div>
      <div class="field">
        <label>Unit / Apt <span class="help">(optional)</span></label>
        <input type="text" class="addr-input" id="addrUnit" placeholder="Apt 2B">
      </div>
      <div class="addr-row">
        <div class="field" style="flex:2">
          <label>City<span class="req">*</span></label>
          <input type="text" class="addr-input" id="addrCity" placeholder="City">
        </div>
        <div class="field" style="flex:1">
          <label>State<span class="req">*</span></label>
          <input type="text" class="addr-input" id="addrState" placeholder="ST" maxlength="2" style="text-transform:uppercase">
        </div>
      </div>
      <div class="field" style="max-width:160px">
        <label>ZIP Code<span class="req">*</span></label>
        <input type="text" class="addr-input" id="addrZip" placeholder="12345" inputmode="numeric" maxlength="10">
      </div>
      <div class="field">
        <label>Number of Units</label>
        <div class="unit-stepper">
          <button type="button" class="step-btn" id="unitMinus">−</button>
          <span class="unit-count" id="unitCount">1</span>
          <button type="button" class="step-btn" id="unitPlus">+</button>
        </div>
      </div>
      <div id="unitCards"></div>
    </div>
  </div>

  <!-- ═══ DEAL INPUTS ═══ -->
  <div class="section">
    <button type="button" class="sec-btn" id="secDealBtn">
      <span>Deal Inputs</span><span class="arrow" id="arrowDeal" style="transform:rotate(90deg)">›</span>
    </button>
    <div class="sec-body open" id="secDeal">
      <div class="field"><label>Purchase Price</label>
        <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="purchasePrice" value="120000" step="1000"></div></div>
      <div class="field"><label>Rehab Budget</label></div>
      <div class="rehab-toggle" id="rehabToggle">
        <button type="button" class="rehab-opt active" data-mode="total">Total Cost</button>
        <button type="button" class="rehab-opt" data-mode="sqft">Per Sq Ft</button>
      </div>
      <div id="rehabTotal">
        <div class="field"><div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="rehabBudget" value="30000" step="1000"></div></div>
      </div>
      <div id="rehabSqft" style="display:none">
        <div class="field"><label>Square Footage</label>
          <div class="iw"><input type="number" inputmode="decimal" id="sqft" value="1200" step="100"><span class="suf">sq ft</span></div></div>
        <div class="field"><label>Cost per Sq Ft</label>
          <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="costPerSqft" value="25" step="1"><span class="suf">/sq ft</span></div></div>
        <div class="io-label">Calculated rehab: <span id="calcRehab">$30,000</span></div>
      </div>
      <div class="field"><label>After Repair Value (ARV)</label>
        <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="arv" value="200000" step="1000"></div></div>
      <div class="field"><label>Monthly Insurance</label>
        <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="monthlyInsurance" value="150" step="10"></div></div>
      <div class="field"><label>Monthly Property Tax</label>
        <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="monthlyTax" value="200" step="10"></div></div>
      <div class="field"><label>Selling Costs <span class="help">agent + closing</span></label>
        <div class="iw"><input type="number" inputmode="decimal" id="sellCostPct" value="6" step="0.5"><span class="suf">%</span></div></div>
    </div>
  </div>

  <!-- ═══ FINANCING ═══ -->
  <div class="section">
    <button type="button" class="sec-btn" id="secFinBtn">
      <span>Financing</span><span class="arrow" id="arrowFin">›</span>
    </button>
    <div class="sec-body" id="secFin">
      <div style="font-size:12px;font-weight:700;color:#6B7280;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Buy &amp; Hold Loan</div>
      <div class="field"><label>Down Payment</label>
        <div class="iw"><input type="number" inputmode="decimal" id="downPct" value="20" step="1"><span class="suf">%</span></div></div>
      <div class="field"><label>Mortgage Rate</label>
        <div class="iw"><input type="number" inputmode="decimal" id="bhRate" value="7.0" step="0.1"><span class="suf">%</span></div></div>
      <div class="field"><label>Loan Term</label>
        <div class="iw"><input type="number" inputmode="decimal" id="bhTermYears" value="30" step="1"><span class="suf">years</span></div></div>

      <div style="border-top:1px solid #E5E7EB;margin:16px 0;padding-top:16px">
        <div style="font-size:12px;font-weight:700;color:#6B7280;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">BRRRR Refinance</div>
      </div>
      <div class="field"><label>Refinance Rate</label>
        <div class="iw"><input type="number" inputmode="decimal" id="refiRate" value="7.0" step="0.1"><span class="suf">%</span></div></div>
      <div class="field"><label>Refinance LTV</label>
        <div class="iw"><input type="number" inputmode="decimal" id="refiLtv" value="75" step="1"><span class="suf">%</span></div></div>
      <div class="field"><label>Refi Loan Term</label>
        <div class="iw"><input type="number" inputmode="decimal" id="refiTermYears" value="30" step="1"><span class="suf">years</span></div></div>
      <div class="tog-row">
        <span>Interest-Only Period</span>
        <button type="button" class="tog-btn" id="ioToggle"><div class="tog-k"></div></button>
      </div>
      <div id="ioFields" style="display:none">
        <div class="field"><label>I/O Period</label>
          <div class="iw"><input type="number" inputmode="decimal" id="ioYears" value="3" step="1"><span class="suf">years</span></div></div>
        <div class="io-label">Loan amortizes fully after I/O period</div>
      </div>

      <div style="border-top:1px solid #E5E7EB;margin:16px 0;padding-top:16px">
        <div style="font-size:12px;font-weight:700;color:#6B7280;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Acquisition (BRRRR/Flip)</div>
      </div>
      <div class="tog-row">
        <span>Use Hard Money / Bridge Loan</span>
        <button type="button" class="tog-btn" id="hmToggle"><div class="tog-k"></div></button>
      </div>
      <div class="hm-fields" id="hmFields">
        <div class="field"><label>Hard Money Rate</label>
          <div class="iw"><input type="number" inputmode="decimal" id="hmRate" value="12" step="0.1"><span class="suf">%</span></div></div>
        <div class="field"><label>Origination Points</label>
          <div class="iw"><input type="number" inputmode="decimal" id="hmPoints" value="2" step="0.5"><span class="suf">%</span></div></div>
        <div class="field"><label>Loan-to-Cost (LTC)</label>
          <div class="iw"><input type="number" inputmode="decimal" id="hmLtc" value="85" step="1"><span class="suf">%</span></div></div>
        <div class="field"><label>Loan Term</label>
          <div class="iw"><input type="number" inputmode="decimal" id="hmTermMonths" value="12" step="1"><span class="suf">months</span></div></div>
      </div>

      <div style="border-top:1px solid #E5E7EB;margin:16px 0;padding-top:16px">
        <div style="font-size:12px;font-weight:700;color:#6B7280;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Flip Timeline</div>
      </div>
      <div class="field"><label>Holding Period</label>
        <div class="iw"><input type="number" inputmode="decimal" id="flipHoldMonths" value="6" step="1"><span class="suf">months</span></div></div>
      <div class="field"><label>Monthly Holding Costs <span class="help">utils, lawn, etc.</span></label>
        <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="flipHoldCostMo" value="500" step="50"></div></div>
    </div>
  </div>

  <!-- ═══ ASSUMPTIONS ═══ -->
  <div class="section">
    <button type="button" class="sec-btn" id="secAssBtn">
      <span>Assumptions</span><span class="arrow" id="arrowAss">›</span>
    </button>
    <div class="sec-body" id="secAss">
      <div class="field"><label>Closing Costs <span class="help">of loan/purchase</span></label>
        <div class="iw"><input type="number" inputmode="decimal" id="closingCostPct" value="3" step="0.5"><span class="suf">%</span></div></div>
      <div class="field"><label>Vacancy Rate</label>
        <div class="iw"><input type="number" inputmode="decimal" id="vacancyPct" value="5" step="1"><span class="suf">%</span></div></div>
      <div class="field"><label>Property Management <span class="help">of eff. rent</span></label>
        <div class="iw"><input type="number" inputmode="decimal" id="mgmtPct" value="8" step="1"><span class="suf">%</span></div></div>
      <div class="field"><label>CapEx / Maintenance <span class="help">of eff. rent</span></label>
        <div class="iw"><input type="number" inputmode="decimal" id="capexPct" value="5" step="1"><span class="suf">%</span></div></div>
      <div class="field"><label>Annual Rent Growth</label>
        <div class="iw"><input type="number" inputmode="decimal" id="rentGrowth" value="3" step="0.5"><span class="suf">%</span></div></div>
      <div class="field"><label>Annual Appreciation</label>
        <div class="iw"><input type="number" inputmode="decimal" id="appreciation" value="3" step="0.5"><span class="suf">%</span></div></div>
    </div>
  </div>

  <button type="button" class="action-btn calc-btn" id="calcBtn">Calculate All Strategies</button>

  <!-- ═══ RESULTS ═══ -->
  <div id="results">

    <!-- Strategy Tabs -->
    <div class="strat-tabs" id="stratTabs">
      <button type="button" class="strat-tab active" data-strat="bh">Buy &amp; Hold</button>
      <button type="button" class="strat-tab" data-strat="brrrr">BRRRR</button>
      <button type="button" class="strat-tab" data-strat="flip">Flip</button>
    </div>

    <!-- ── BUY & HOLD ── -->
    <div class="strat-panel active" id="panel_bh">
      <div class="mg">
        <div class="mc"><div class="ml">Cash-on-Cash</div><div class="mv" id="bh_coc">—</div><div class="ms">Year 1</div></div>
        <div class="mc"><div class="ml">10-Year IRR</div><div class="mv" id="bh_irr">—</div><div class="ms">Incl. sale</div></div>
        <div class="mc"><div class="ml">MOIC</div><div class="mv" id="bh_moic">—</div><div class="ms">10-year</div></div>
        <div class="mc"><div class="ml">Mo. Cash Flow</div><div class="mv" id="bh_mcf">—</div><div class="ms">Year 1</div></div>
      </div>
      <div class="card">
        <div class="ct">Buy &amp; Hold Capital Stack</div>
        <div class="row"><span>Purchase Price</span><span class="v" id="bh_pp">—</span></div>
        <div class="row"><span>+ Rehab</span><span class="v" id="bh_rehab">—</span></div>
        <div class="row"><span>+ Furnishing (STR)</span><span class="v" id="bh_furn">—</span></div>
        <div class="row"><span>+ Closing Costs</span><span class="v" id="bh_close">—</span></div>
        <div class="row divr" style="font-weight:700"><span>Down Payment</span><span class="v" id="bh_down">—</span></div>
        <div class="row"><span>Loan Amount</span><span class="v" id="bh_loan">—</span></div>
        <div class="hlr"><span>Total Cash Invested</span><span id="bh_cashin">—</span></div>
      </div>
      <div class="card">
        <div class="ct">Monthly Cash Flow (Year 1)</div>
        <div id="bh_unit_rents"></div>
        <div class="row"><span>Total Gross Rent</span><span class="v" id="bh_gross">—</span></div>
        <div class="row"><span>− Vacancy</span><span class="v" id="bh_vac">—</span></div>
        <div class="row"><span>− Insurance</span><span class="v" id="bh_ins">—</span></div>
        <div class="row"><span>− Taxes</span><span class="v" id="bh_tax">—</span></div>
        <div class="row"><span>− Management</span><span class="v" id="bh_mgmt">—</span></div>
        <div class="row"><span>− CapEx Reserve</span><span class="v" id="bh_capex">—</span></div>
        <div class="row"><span>− Mortgage</span><span class="v" id="bh_mort">—</span></div>
        <div class="row divr" style="font-weight:700;font-size:14px"><span>Net Cash Flow</span><span class="v" id="bh_ncf">—</span></div>
      </div>
    </div>

    <!-- ── BRRRR ── -->
    <div class="strat-panel" id="panel_brrrr">
      <div class="mg">
        <div class="mc"><div class="ml">Cash-on-Cash</div><div class="mv" id="br_coc">—</div><div class="ms">Year 1, levered</div></div>
        <div class="mc"><div class="ml">Unlevered CoC</div><div class="mv" id="br_unlev">—</div><div class="ms">Year 1</div></div>
        <div class="mc"><div class="ml">10-Year IRR</div><div class="mv" id="br_irr">—</div><div class="ms">Incl. sale</div></div>
        <div class="mc"><div class="ml">MOIC</div><div class="mv" id="br_moic">—</div><div class="ms">10-year</div></div>
      </div>
      <div class="card">
        <div class="ct">BRRRR Capital Stack</div>
        <div class="row"><span>Total Project Cost</span><span class="v" id="br_tpc">—</span></div>
        <div class="row"><span>+ Furnishing (STR)</span><span class="v" id="br_furn">—</span></div>
        <div class="row" id="br_hmrow" style="display:none"><span>+ HM Points &amp; Interest</span><span class="v" id="br_hmcost">—</span></div>
        <div class="row"><span>+ Purchase Closing</span><span class="v" id="br_pclose">—</span></div>
        <div class="row divr" style="font-weight:700"><span>Total Cash Out</span><span class="v" id="br_cashout">—</span></div>
        <div class="row"><span>Refi Loan Amount</span><span class="v" id="br_refiloan">—</span></div>
        <div class="row"><span>− Refi Closing</span><span class="v" id="br_reficlose">—</span></div>
        <div class="row" id="br_hmpayrow" style="display:none"><span>− HM Payoff</span><span class="v" id="br_hmpay">—</span></div>
        <div class="row"><span>= Cash Back at Refi</span><span class="v grn" id="br_cashback">—</span></div>
        <div class="hlr"><span>Cash Left in Deal</span><span id="br_cashin">—</span></div>
      </div>
      <div class="card">
        <div class="ct">Monthly Cash Flow (Year 1)</div>
        <div id="br_unit_rents"></div>
        <div class="row"><span>Total Gross Rent</span><span class="v" id="br_gross">—</span></div>
        <div class="row"><span>− Vacancy</span><span class="v" id="br_vac">—</span></div>
        <div class="row"><span>− Insurance</span><span class="v" id="br_ins">—</span></div>
        <div class="row"><span>− Taxes</span><span class="v" id="br_tax">—</span></div>
        <div class="row"><span>− Management</span><span class="v" id="br_mgmt">—</span></div>
        <div class="row"><span>− CapEx Reserve</span><span class="v" id="br_capex">—</span></div>
        <div class="row"><span>− Mortgage</span><span class="v" id="br_mort">—</span></div>
        <div class="row" id="br_iolabel" style="display:none;color:#D97706;font-style:italic"><span></span><span class="v"></span></div>
        <div class="row divr" style="font-weight:700;font-size:14px"><span>Net Cash Flow</span><span class="v" id="br_ncf">—</span></div>
      </div>
    </div>

    <!-- ── FLIP ── -->
    <div class="strat-panel" id="panel_flip">
      <div class="card" style="text-align:center;background:linear-gradient(135deg,#ECFDF5,#D1FAE5)">
        <div class="ml" style="text-align:center">Estimated Flip Profit</div>
        <div class="flip-profit" id="fl_profit">—</div>
        <div style="display:flex;justify-content:center;gap:20px;margin-top:8px">
          <div><div class="ml">ROI</div><div style="font-size:18px;font-weight:700" id="fl_roi">—</div></div>
          <div><div class="ml">Annualized</div><div style="font-size:18px;font-weight:700" id="fl_aroi">—</div></div>
        </div>
      </div>
      <div class="card">
        <div class="ct">Flip Breakdown</div>
        <div class="row"><span>Purchase Price</span><span class="v" id="fl_pp">—</span></div>
        <div class="row"><span>+ Rehab</span><span class="v" id="fl_rehab">—</span></div>
        <div class="row"><span>+ Purchase Closing</span><span class="v" id="fl_bclose">—</span></div>
        <div class="row" id="fl_hmrow" style="display:none"><span>+ HM Points &amp; Interest</span><span class="v" id="fl_hmcost">—</span></div>
        <div class="row"><span>+ Holding Costs</span><span class="v" id="fl_hold">—</span></div>
        <div class="row divr" style="font-weight:700"><span>Total Cost</span><span class="v" id="fl_totalcost">—</span></div>
        <div style="height:8px"></div>
        <div class="row"><span>Sale Price (ARV)</span><span class="v" id="fl_arv">—</span></div>
        <div class="row"><span>− Selling Costs</span><span class="v" id="fl_sellcost">—</span></div>
        <div class="row" id="fl_hmpayrow" style="display:none"><span>− HM Loan Payoff</span><span class="v" id="fl_hmpay">—</span></div>
        <div class="row divr" style="font-weight:700"><span>Net Proceeds</span><span class="v" id="fl_proceeds">—</span></div>
        <div class="hlr"><span>Profit</span><span id="fl_profitline">—</span></div>
      </div>
      <div class="mg">
        <div class="mc"><div class="ml">Cash Invested</div><div class="mv blu" id="fl_cashin">—</div><div class="ms">Out of pocket</div></div>
        <div class="mc"><div class="ml">Hold Time</div><div class="mv blu" id="fl_time">—</div><div class="ms">Months</div></div>
      </div>
    </div>

    <!-- Shared: Pro Forma (Buy&Hold / BRRRR) -->
    <div id="pfSection">
      <button type="button" class="action-btn pf-btn" id="pfToggle">Show 10-Year Pro Forma</button>
      <div class="card" id="pfCard" style="display:none">
        <div class="ct" id="pfTitle">10-Year Pro Forma</div>
        <div class="pfw">
          <table><thead><tr><th>Yr</th><th>Eff. Rent</th><th>OpEx</th><th>NOI</th><th>Debt Svc</th><th>Cash Flow</th><th>Prop Value</th><th>Loan Bal</th><th>Equity</th></tr></thead>
          <tbody id="pfBody"></tbody></table>
        </div>
        <div class="pfn" id="pfNote"></div>
      </div>
    </div>

    <button type="button" class="action-btn sa-btn" id="saToggle">Show Sensitivity Analysis</button>
    <div class="card" id="saCard" style="display:none">
      <div class="ct" id="saCocTitle">Sensitivity: Cash-on-Cash Return</div>
      <div class="pfw"><table class="sens-tbl" id="saCocTbl"></table></div>
      <div style="height:16px"></div>
      <div class="ct" id="saIrrTitle">Sensitivity: 10-Year IRR</div>
      <div class="pfw"><table class="sens-tbl" id="saIrrTbl"></table></div>
      <div class="pfn">Rows = vacancy shifts, Columns = rent shifts from base</div>
    </div>

    <button type="button" class="action-btn dl-btn" id="dlBtn">Download Excel Worksheet</button>

    <div style="margin-top:20px;padding:16px;background:#FEF3C7;border:1px solid #F59E0B;border-radius:12px">
      <div style="font-size:12px;font-weight:700;color:#92400E;margin-bottom:6px">IMPORTANT DISCLAIMER</div>
      <div style="font-size:11px;color:#78350F;line-height:1.6">This tool is for <strong>informational and educational purposes only</strong> and does not constitute financial, investment, legal, tax, or real estate advice. All projections are hypothetical estimates based on user inputs.</div>
      <button type="button" class="action-btn" id="discBtn" style="background:#92400E;font-size:12px;padding:10px;margin-top:8px;margin-bottom:0">Read Full Disclaimer</button>
      <div id="discFull" style="display:none;margin-top:10px;font-size:11px;color:#78350F;line-height:1.6">
        <p style="margin-bottom:8px"><strong>No Warranty.</strong> Projections including CoC, IRR, MOIC, NOI, and all pro forma outputs are estimates only. Actual results will vary materially. Past performance is not indicative of future results.</p>
        <p style="margin-bottom:8px"><strong>Not Professional Advice.</strong> Consult licensed real estate agents, CPAs, financial advisors, and attorneys before making investment decisions. The creators are not licensed professionals.</p>
        <p style="margin-bottom:8px"><strong>Assumption Limitations.</strong> Projections may not reflect actual market conditions. The tool does not account for all risks including environmental hazards, zoning changes, market downturns, tenant defaults, and regulatory changes.</p>
        <p style="margin-bottom:8px"><strong>Investment Risk.</strong> Real estate investment involves substantial risk including potential total loss. Leverage amplifies both gains and losses.</p>
        <p style="margin-bottom:8px"><strong>Limitation of Liability.</strong> Creators disclaim all liability for damages arising from use of this tool or reliance on its outputs.</p>
        <p><strong>No Fiduciary Relationship.</strong> Use of this tool creates no advisory or professional relationship.</p>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script>
(function(){
var $=function(id){return document.getElementById(id)};
var vl=function(id){return parseFloat($(id).value)||0};
var fmt=function(x){return x==null?"---":"$"+Math.round(x).toLocaleString()};
var fPct=function(x){return x==null?"---":(x*100).toFixed(2)+"%"};
var fX=function(x){return x==null?"---":x.toFixed(2)+"x"};
function pmtCalc(r,n,pv){if(r===0)return -pv/n;var x=Math.pow(1+r,n);return(-pv*r*x)/(x-1)}
function loanBalF(r,n,pv,e){if(r===0)return pv-(pv/n)*e;var x=Math.pow(1+r,n),y=Math.pow(1+r,e);return pv*(x-y)/(x-1)}
function calcIRR(cf){var r=0.1;for(var i=0;i<1000;i++){var npv=0,dnpv=0;for(var t=0;t<cf.length;t++){var d=Math.pow(1+r,t);npv+=cf[t]/d;dnpv-=t*cf[t]/(d*(1+r))}var nr=r-npv/dnpv;if(Math.abs(nr-r)<1e-8)return nr;r=nr;if(!isFinite(r)||r<-1)return null}return null}
function annDS(rRate,termYrs,loan,yr,io,ioYrs){var mr=rRate/12;if(io&&yr<=ioYrs)return loan*mr*12;if(io&&yr>ioYrs){var rt=(termYrs-ioYrs)*12;return-pmtCalc(mr,rt,loan)*12}return-pmtCalc(mr,termYrs*12,loan)*12}
function loanBalY(rRate,termYrs,loan,yr,io,ioYrs){var mr=rRate/12;if(io){if(yr<=ioYrs)return loan;return loanBalF(mr,(termYrs-ioYrs)*12,loan,(yr-ioYrs)*12)}return loanBalF(mr,termYrs*12,loan,yr*12)}

var useHM=false,useIO=false,showPF=false,showSA=false,numUnits=1,rehabMode='total',activeStrat='bh';
var units=[{type:'ltr',rent:1800,nightly:150,occ:70,furnish:0}];
var lastBH=null,lastBR=null,lastFL=null;

// ─── Section Toggles ─────────────────────────────────────────
function setupSec(bid,bodyid,aid,open){
  var b=$(bid),bd=$(bodyid),ar=$(aid),isO=open;
  function t(e){e.preventDefault();isO=!isO;if(isO){bd.classList.add('open');ar.style.transform='rotate(90deg)'}else{bd.classList.remove('open');ar.style.transform='rotate(0deg)'}}
  b.addEventListener('click',t,false);b.addEventListener('touchend',function(e){e.preventDefault();t(e)},false);
}
setupSec('secPropBtn','secProp','arrowProp',true);
setupSec('secDealBtn','secDeal','arrowDeal',true);
setupSec('secFinBtn','secFin','arrowFin',false);
setupSec('secAssBtn','secAss','arrowAss',false);

// ─── Strategy Tabs ───────────────────────────────────────────
var stratBtns=document.querySelectorAll('.strat-tab');
for(var si=0;si<stratBtns.length;si++){
  (function(btn){
    function handler(e){
      e.preventDefault();
      activeStrat=btn.getAttribute('data-strat');
      for(var k=0;k<stratBtns.length;k++)stratBtns[k].classList.remove('active');
      btn.classList.add('active');
      document.querySelectorAll('.strat-panel').forEach(function(p){p.classList.remove('active')});
      $('panel_'+activeStrat).classList.add('active');
      $('pfSection').style.display=activeStrat==='flip'?'none':'block';
      updatePF();
    }
    btn.addEventListener('click',handler,false);
    btn.addEventListener('touchend',function(e){e.preventDefault();handler(e)},false);
  })(stratBtns[si]);
}

// ─── Unit Cards ──────────────────────────────────────────────
function saveUD(){
  var cards=document.querySelectorAll('.unit-card');
  for(var i=0;i<cards.length&&i<units.length;i++){
    var ri=cards[i].querySelector('.u-rent'),ni=cards[i].querySelector('.u-nightly'),oi=cards[i].querySelector('.u-occ'),fi=cards[i].querySelector('.u-furn');
    if(ri)units[i].rent=parseFloat(ri.value)||0;
    if(ni)units[i].nightly=parseFloat(ni.value)||0;
    if(oi)units[i].occ=parseFloat(oi.value)||0;
    if(fi)units[i].furnish=parseFloat(fi.value)||0;
  }
}

function buildCards(){
  saveUD();
  var c=$('unitCards'),html='';
  for(var i=0;i<numUnits;i++){
    if(i>=units.length)units.push({type:'ltr',rent:1800,nightly:150,occ:70,furnish:0});
    var u=units[i],isL=u.type==='ltr';
    html+='<div class="unit-card" data-idx="'+i+'"><div class="unit-hdr"><span>Unit '+(i+1)+'</span>';
    html+='<div class="type-toggle"><button type="button" class="type-opt'+(isL?' active':'')+'" data-t="ltr">LTR</button><button type="button" class="type-opt'+(!isL?' active':'')+'" data-t="str">STR</button></div></div>';
    html+='<div class="unit-fields">';
    if(isL){
      html+='<div class="unit-fields-row"><div class="field"><label>Monthly Rent</label><div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" class="u-rent" value="'+u.rent+'" step="50"></div></div></div>';
    }else{
      html+='<div class="unit-fields-row"><div class="field"><label>Avg Nightly Rate</label><div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" class="u-nightly" value="'+u.nightly+'" step="5"></div></div>';
      html+='<div class="field"><label>Occupancy</label><div class="iw"><input type="number" inputmode="decimal" class="u-occ" value="'+u.occ+'" step="1"><span class="suf">%</span></div></div></div>';
      var mo=Math.round(u.nightly*(u.occ/100)*30.44);
      html+='<div class="str-calc">= $'+mo.toLocaleString()+'/mo estimated revenue</div>';
      html+='<div class="field"><label>Furnishing Cost</label><div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" class="u-furn" value="'+u.furnish+'" step="500"></div></div>';
    }
    html+='</div></div>';
  }
  c.innerHTML=html;
  $('unitCount').textContent=numUnits;

  // Live STR calc
  c.querySelectorAll('.u-nightly, .u-occ').forEach(function(inp){
    inp.addEventListener('input',function(){
      var card=inp.closest('.unit-card');
      var ni=card.querySelector('.u-nightly'),oi=card.querySelector('.u-occ'),calc=card.querySelector('.str-calc');
      if(ni&&oi&&calc){
        var mo=Math.round((parseFloat(ni.value)||0)*((parseFloat(oi.value)||0)/100)*30.44);
        calc.textContent='= $'+mo.toLocaleString()+'/mo estimated revenue';
      }
    });
  });

  // Type toggles
  c.querySelectorAll('.type-opt').forEach(function(btn){
    function h(e){e.preventDefault();var card=btn.closest('.unit-card');var idx=parseInt(card.getAttribute('data-idx'));saveUD();units[idx].type=btn.getAttribute('data-t');buildCards()}
    btn.addEventListener('click',h,false);btn.addEventListener('touchend',function(e){e.preventDefault();h(e)},false);
  });
}

function addU(e){if(e)e.preventDefault();if(numUnits<20){numUnits++;buildCards()}}
function remU(e){if(e)e.preventDefault();if(numUnits>1){saveUD();numUnits--;units.length=numUnits;buildCards()}}
$('unitPlus').addEventListener('click',addU,false);$('unitPlus').addEventListener('touchend',function(e){e.preventDefault();addU(e)},false);
$('unitMinus').addEventListener('click',remU,false);$('unitMinus').addEventListener('touchend',function(e){e.preventDefault();remU(e)},false);

// ─── Rehab Toggle ────────────────────────────────────────────
var rehabBtns=document.querySelectorAll('.rehab-opt');
rehabBtns.forEach(function(btn){
  function h(e){e.preventDefault();rehabMode=btn.getAttribute('data-mode');rehabBtns.forEach(function(b){b.classList.remove('active')});btn.classList.add('active');$('rehabTotal').style.display=rehabMode==='total'?'block':'none';$('rehabSqft').style.display=rehabMode==='sqft'?'block':'none';updRehab()}
  btn.addEventListener('click',h,false);btn.addEventListener('touchend',function(e){e.preventDefault();h(e)},false);
});
function updRehab(){if(rehabMode==='sqft')$('calcRehab').textContent=fmt(vl('sqft')*vl('costPerSqft'))}
['sqft','costPerSqft'].forEach(function(id){$(id).addEventListener('input',updRehab)});

// ─── Toggles ─────────────────────────────────────────────────
function setupTog(btnId,cb){var btn=$(btnId);btn.addEventListener('click',function(e){e.preventDefault();cb()},false);btn.addEventListener('touchend',function(e){e.preventDefault();cb()},false)}
setupTog('ioToggle',function(){useIO=!useIO;$('ioToggle').classList.toggle('on');$('ioFields').style.display=useIO?'block':'none'});
setupTog('hmToggle',function(){useHM=!useHM;$('hmToggle').classList.toggle('on');$('hmFields').classList.toggle('show')});

var showPF=false,showSA=false;
setupTog('pfToggle',function(){showPF=!showPF;$('pfCard').style.display=showPF?'block':'none';$('pfToggle').textContent=showPF?'Hide 10-Year Pro Forma':'Show 10-Year Pro Forma'});
setupTog('saToggle',function(){showSA=!showSA;$('saCard').style.display=showSA?'block':'none';$('saToggle').textContent=showSA?'Hide Sensitivity Analysis':'Show Sensitivity Analysis'});
setupTog('discBtn',function(){var o=$('discFull').style.display==='block';$('discFull').style.display=o?'none':'block';$('discBtn').textContent=o?'Read Full Disclaimer':'Hide Full Disclaimer'});

// ─── Getters ─────────────────────────────────────────────────
function getRents(){saveUD();var r=[];for(var i=0;i<numUnits;i++){var u=units[i];r.push(u.type==='ltr'?u.rent:Math.round(u.nightly*(u.occ/100)*30.44))}return r}
function getTotalFurnish(){saveUD();var t=0;for(var i=0;i<numUnits;i++)if(units[i].type==='str')t+=units[i].furnish;return t}
function getRehab(){return rehabMode==='sqft'?vl('sqft')*vl('costPerSqft'):vl('rehabBudget')}

// ─── Shared inputs ───────────────────────────────────────────
function getInputs(rentOv,vacOv){
  var rents=rentOv||getRents();var totalR=0;for(var i=0;i<rents.length;i++)totalR+=rents[i];
  return{pp:vl('purchasePrice'),rehab:getRehab(),arv:vl('arv'),rent:totalR,rents:rents,
    ins:vl('monthlyInsurance'),tax:vl('monthlyTax'),closePct:vl('closingCostPct')/100,
    vacRate:vacOv!=null?vacOv/100:vl('vacancyPct')/100,mgmt:vl('mgmtPct')/100,capex:vl('capexPct')/100,
    rGrowth:vl('rentGrowth')/100,appRate:vl('appreciation')/100,sellPct:vl('sellCostPct')/100,
    furnish:getTotalFurnish()};
}

// ─── Buy & Hold Analysis ─────────────────────────────────────
function analyzeBH(rentOv,vacOv){
  var inp=getInputs(rentOv,vacOv);if(inp.pp<=0||inp.arv<=0)return null;
  var downPct=vl('downPct')/100,bhRate=vl('bhRate')/100,bhTerm=vl('bhTermYears');
  var downAmt=inp.pp*downPct;
  var loanAmt=inp.pp-downAmt;
  var buyClose=inp.pp*inp.closePct;
  var totalCashIn=downAmt+buyClose+inp.rehab+inp.furnish;
  var moMort=loanAmt>0?-pmtCalc(bhRate/12,bhTerm*12,loanAmt):0;

  var years=[],irrCF=[-totalCashIn];
  for(var yr=1;yr<=10;yr++){
    var annR=inp.rent*12*Math.pow(1+inp.rGrowth,yr-1);
    var effR=annR*(1-inp.vacRate);
    var opex=effR*inp.mgmt+effR*inp.capex+(inp.ins+inp.tax)*12;
    var noi=effR-opex;var ds=moMort*12;var cf=noi-ds;
    var pv=inp.arv*Math.pow(1+inp.appRate,yr);
    var rl=loanAmt>0?loanBalF(bhRate/12,bhTerm*12,loanAmt,yr*12):0;
    var eq=pv-rl;
    var sp=yr===10?pv-rl-pv*inp.sellPct:0;
    years.push({yr:yr,effRent:effR,opex:opex,noi:noi,debtSvc:ds,cf:cf,propVal:pv,remLoan:rl,equity:eq,saleProceeds:sp});
    irrCF.push(yr<10?cf:cf+sp);
  }
  var coc=totalCashIn>0?years[0].cf/totalCashIn:null;
  var irr=calcIRR(irrCF);
  var totCF=0;for(var i=0;i<10;i++)totCF+=years[i].cf;
  var moic=totalCashIn>0?(totCF+years[9].saleProceeds)/totalCashIn:null;
  return{totalCashIn:totalCashIn,downAmt:downAmt,loanAmt:loanAmt,buyClose:buyClose,moMort:moMort,
    coc:coc,irr:irr,moic:moic,years:years,inp:inp};
}

// ─── BRRRR Analysis ──────────────────────────────────────────
function analyzeBR(rentOv,vacOv){
  var inp=getInputs(rentOv,vacOv);if(inp.pp<=0||inp.arv<=0)return null;
  var rRate=vl('refiRate')/100,ltv=vl('refiLtv')/100,termYrs=vl('refiTermYears');
  var ioYrs=useIO?vl('ioYears'):0;
  var tpc=inp.pp+inp.rehab;
  var initCash=tpc+inp.furnish;var hmInt=0,hmPts=0,hmPay=0;
  if(useHM){var hmr=vl('hmRate')/100,hmp=vl('hmPoints')/100,hltc=vl('hmLtc')/100,hterm=vl('hmTermMonths');
    var hLoan=tpc*hltc;hmPts=hLoan*hmp;hmInt=hLoan*(hmr/12)*hterm;
    initCash=tpc+inp.furnish-hLoan+hmPts+hmInt;hmPay=hLoan;}
  var pClose=inp.pp*inp.closePct;initCash+=pClose;
  var refiLoan=inp.arv*ltv;var refiClose=refiLoan*inp.closePct;
  var cashBack=refiLoan-refiClose-hmPay;
  var totalCashIn=Math.max(initCash-cashBack,0);

  var years=[],irrCF=[-totalCashIn];
  for(var yr=1;yr<=10;yr++){
    var annR=inp.rent*12*Math.pow(1+inp.rGrowth,yr-1);
    var effR=annR*(1-inp.vacRate);
    var opex=effR*inp.mgmt+effR*inp.capex+(inp.ins+inp.tax)*12;
    var noi=effR-opex;
    var ds=annDS(rRate,termYrs,refiLoan,yr,useIO,ioYrs);
    var cf=noi-ds;
    var pv=inp.arv*Math.pow(1+inp.appRate,yr);
    var rl=loanBalY(rRate,termYrs,refiLoan,yr,useIO,ioYrs);
    var eq=pv-rl;var sp=yr===10?pv-rl-pv*inp.sellPct:0;
    years.push({yr:yr,effRent:effR,opex:opex,noi:noi,debtSvc:ds,cf:cf,propVal:pv,remLoan:rl,equity:eq,saleProceeds:sp});
    irrCF.push(yr<10?cf:cf+sp);
  }
  var coc=totalCashIn>0?years[0].cf/totalCashIn:null;
  var unlev=(tpc+inp.furnish+pClose)>0?years[0].noi/(tpc+inp.furnish+pClose):null;
  var irr=calcIRR(irrCF);
  var totCF=0;for(var i=0;i<10;i++)totCF+=years[i].cf;
  var moic=totalCashIn>0?(totCF+years[9].saleProceeds)/totalCashIn:null;
  return{totalCashIn:totalCashIn,tpc:tpc,initCash:initCash,pClose:pClose,refiLoan:refiLoan,refiClose:refiClose,
    cashBack:cashBack,hmInt:hmInt,hmPts:hmPts,hmPay:hmPay,
    coc:coc,unlev:unlev,irr:irr,moic:moic,years:years,inp:inp,rRate:rRate};
}

// ─── Flip Analysis ───────────────────────────────────────────
function analyzeFL(){
  var inp=getInputs();if(inp.pp<=0||inp.arv<=0)return null;
  var holdMo=vl('flipHoldMonths'),holdCostMo=vl('flipHoldCostMo');
  var tpc=inp.pp+inp.rehab;
  var buyClose=inp.pp*inp.closePct;
  var holdCosts=(inp.ins+inp.tax+holdCostMo)*holdMo;
  var hmInt=0,hmPts=0,hmPay=0,hmLoan=0;
  if(useHM){var hmr=vl('hmRate')/100,hmp=vl('hmPoints')/100,hltc=vl('hmLtc')/100;
    hmLoan=tpc*hltc;hmPts=hmLoan*hmp;hmInt=hmLoan*(hmr/12)*holdMo;hmPay=hmLoan;}
  var totalCost=tpc+buyClose+holdCosts+hmPts+hmInt;
  var cashInvested=useHM?tpc-hmLoan+buyClose+holdCosts+hmPts+hmInt:totalCost;
  var sellCosts=inp.arv*inp.sellPct;
  var netProceeds=inp.arv-sellCosts-hmPay;
  var profit=netProceeds-cashInvested;
  var roi=cashInvested>0?profit/cashInvested:null;
  var annRoi=roi!=null&&holdMo>0?Math.pow(1+roi,12/holdMo)-1:null;
  return{tpc:tpc,buyClose:buyClose,holdCosts:holdCosts,hmInt:hmInt,hmPts:hmPts,hmPay:hmPay,hmLoan:hmLoan,
    totalCost:totalCost,cashInvested:cashInvested,sellCosts:sellCosts,netProceeds:netProceeds,
    profit:profit,roi:roi,annRoi:annRoi,holdMo:holdMo,inp:inp};
}

// ─── Render helpers ──────────────────────────────────────────
function setMV(id,val,threshold){var el=$(id);el.textContent=fPct(val);el.className='mv '+(val>threshold?'grn':'red')}
function unitRentsHtml(rents){var h='';if(numUnits>1)for(var i=0;i<rents.length;i++){var t=units[i].type==='str'?' (STR)':' (LTR)';h+='<div class="row" style="color:#9CA3AF"><span>Unit '+(i+1)+t+'</span><span class="v">'+fmt(rents[i])+'/mo</span></div>'}return h}
function fillCF(pre,inp,moMort){
  $(pre+'_unit_rents').innerHTML=unitRentsHtml(inp.rents);
  $(pre+'_gross').textContent=fmt(inp.rent);
  $(pre+'_vac').textContent=fmt(inp.rent*inp.vacRate);
  $(pre+'_ins').textContent=fmt(inp.ins);
  $(pre+'_tax').textContent=fmt(inp.tax);
  var eff=inp.rent*(1-inp.vacRate);
  $(pre+'_mgmt').textContent=fmt(eff*inp.mgmt);
  $(pre+'_capex').textContent=fmt(eff*inp.capex);
  $(pre+'_mort').textContent=fmt(moMort);
}

// ─── Pro Forma ───────────────────────────────────────────────
function updatePF(){
  var data=activeStrat==='bh'?lastBH:lastBR;
  if(!data)return;
  var html='';
  for(var i=0;i<data.years.length;i++){var y=data.years[i];
    html+='<tr><td class="yr">'+y.yr+'</td><td>'+fmt(y.effRent)+'</td><td>'+fmt(y.opex)+'</td><td style="font-weight:600">'+fmt(y.noi)+'</td><td>'+fmt(y.debtSvc)+'</td><td style="font-weight:700" class="'+(y.cf>=0?'grn':'red')+'">'+fmt(y.cf)+'</td><td>'+fmt(y.propVal)+'</td><td>'+fmt(y.remLoan)+'</td><td style="font-weight:600" class="blu">'+fmt(y.equity)+'</td></tr>';}
  $('pfBody').innerHTML=html;
  $('pfTitle').textContent='10-Year Pro Forma — '+(activeStrat==='bh'?'Buy & Hold':'BRRRR');
  $('pfNote').textContent='Year 10 sale at '+vl('appreciation')+'% annual appreciation, '+vl('sellCostPct')+'% selling costs';
}

// ─── Sensitivity ─────────────────────────────────────────────
function buildSens(){
  var baseRents=getRents(),baseVac=vl('vacancyPct');
  var rs=[-20,-10,0,10,20],vs=[-4,-2,0,2,4];
  var fn=activeStrat==='bh'?analyzeBH:analyzeBR;
  $('saCocTitle').textContent='Sensitivity: CoC Return ('+(activeStrat==='bh'?'Buy & Hold':'BRRRR')+')';
  $('saIrrTitle').textContent='Sensitivity: 10-Year IRR ('+(activeStrat==='bh'?'Buy & Hold':'BRRRR')+')';

  function build(tid,met){
    var h='<tr><th></th>';
    for(var c=0;c<rs.length;c++)h+='<th>'+(rs[c]===0?'Base':(rs[c]>0?'+':'')+rs[c]+'%')+'</th>';
    h+='</tr>';
    for(var r=0;r<vs.length;r++){
      var vv=Math.max(0,baseVac+vs[r]);
      h+='<tr><td>'+(vs[r]===0?'Base':vv.toFixed(0)+'%')+'</td>';
      for(var c=0;c<rs.length;c++){
        var adj=baseRents.map(function(x){return Math.round(x*(1+rs[c]/100))});
        var res=fn(adj,vv);
        var val=res?res[met]:null;
        var isB=rs[c]===0&&vs[r]===0;
        var cls=isB?'base':'';
        if(val!=null)cls+=' '+(val>0?'grn':'red');
        h+='<td class="'+cls+'">'+fPct(val)+'</td>';
      }
      h+='</tr>';
    }
    $(tid).innerHTML=h;
  }
  build('saCocTbl','coc');
  build('saIrrTbl','irr');
}

// ─── Address Validation ─────────────────────────────────────
function getFullAddress(){
  var s=$('addrStreet').value.trim(),u=$('addrUnit').value.trim(),c=$('addrCity').value.trim(),st=$('addrState').value.trim().toUpperCase(),z=$('addrZip').value.trim();
  var line=s;if(u)line+=' '+u;if(c)line+=', '+c;if(st)line+=', '+st;if(z)line+=' '+z;return line;
}
function validateAddr(){
  var ids=['addrStreet','addrCity','addrState','addrZip'],ok=true;
  for(var i=0;i<ids.length;i++){var el=$(ids[i]);if(!el.value.trim()){el.classList.add('addr-err');ok=false}else{el.classList.remove('addr-err')}}
  $('addrErr').classList.toggle('show',!ok);
  if(!ok){$('addrStreet').scrollIntoView({behavior:'smooth',block:'center'})}
  return ok;
}
['addrStreet','addrCity','addrState','addrZip'].forEach(function(id){$(id).addEventListener('input',function(){$(id).classList.remove('addr-err');$('addrErr').classList.remove('show')})});

// ─── Main Calculate ──────────────────────────────────────────
function calculate(e){
  if(e)e.preventDefault();
  if(!validateAddr())return;
  lastBH=analyzeBH();lastBR=analyzeBR();lastFL=analyzeFL();
  if(!lastBH&&!lastBR)return;
  $('results').classList.add('show');

  // Buy & Hold
  if(lastBH){
    var b=lastBH;
    setMV('bh_coc',b.coc,0);setMV('bh_irr',b.irr,0);
    $('bh_moic').textContent=fX(b.moic);$('bh_moic').className='mv '+(b.moic>1?'grn':'red');
    var mcf=b.years[0].cf/12;$('bh_mcf').textContent=fmt(mcf);$('bh_mcf').className='mv '+(mcf>=0?'grn':'red');
    $('bh_pp').textContent=fmt(b.inp.pp);$('bh_rehab').textContent=fmt(b.inp.rehab);
    $('bh_furn').textContent=fmt(b.inp.furnish);$('bh_close').textContent=fmt(b.buyClose);
    $('bh_down').textContent=fmt(b.downAmt);$('bh_loan').textContent=fmt(b.loanAmt);
    $('bh_cashin').textContent=fmt(b.totalCashIn);
    fillCF('bh',b.inp,b.moMort);
    var ncf=$('bh_ncf');ncf.textContent=fmt(mcf)+'/mo';ncf.className='v '+(mcf>=0?'grn':'red');
  }

  // BRRRR
  if(lastBR){
    var r=lastBR;
    setMV('br_coc',r.coc,0);
    $('br_unlev').textContent=fPct(r.unlev);$('br_unlev').className='mv '+(r.unlev>0?'blu':'red');
    setMV('br_irr',r.irr,0);
    $('br_moic').textContent=fX(r.moic);$('br_moic').className='mv '+(r.moic>1?'grn':'red');
    $('br_tpc').textContent=fmt(r.tpc);$('br_furn').textContent=fmt(r.inp.furnish);
    if(useHM&&r.hmPts>0){$('br_hmrow').style.display='flex';$('br_hmcost').textContent=fmt(r.hmPts+r.hmInt)}else{$('br_hmrow').style.display='none'}
    $('br_pclose').textContent=fmt(r.pClose);$('br_cashout').textContent=fmt(r.initCash);
    $('br_refiloan').textContent=fmt(r.refiLoan);$('br_reficlose').textContent=fmt(r.refiClose);
    if(useHM){$('br_hmpayrow').style.display='flex';$('br_hmpay').textContent=fmt(r.hmPay)}else{$('br_hmpayrow').style.display='none'}
    $('br_cashback').textContent=fmt(r.cashBack);$('br_cashin').textContent=fmt(r.totalCashIn);
    var moDS=r.years[0].debtSvc/12;
    fillCF('br',r.inp,moDS);
    if(useIO){$('br_iolabel').style.display='flex';$('br_iolabel').querySelector('span').textContent='(I/O for '+vl('ioYears')+' yrs)'}else{$('br_iolabel').style.display='none'}
    var bncf=r.years[0].cf/12;var bel=$('br_ncf');bel.textContent=fmt(bncf)+'/mo';bel.className='v '+(bncf>=0?'grn':'red');
  }

  // Flip
  if(lastFL){
    var f=lastFL;
    var pEl=$('fl_profit');pEl.textContent=fmt(f.profit);pEl.className='flip-profit '+(f.profit>=0?'grn':'red');
    $('fl_roi').textContent=fPct(f.roi);$('fl_roi').className=(f.roi>0?'grn':'red');
    $('fl_aroi').textContent=fPct(f.annRoi);$('fl_aroi').className=(f.annRoi>0?'grn':'red');
    $('fl_pp').textContent=fmt(f.inp.pp);$('fl_rehab').textContent=fmt(f.inp.rehab);
    $('fl_bclose').textContent=fmt(f.buyClose);
    if(useHM){$('fl_hmrow').style.display='flex';$('fl_hmcost').textContent=fmt(f.hmPts+f.hmInt);$('fl_hmpayrow').style.display='flex';$('fl_hmpay').textContent=fmt(f.hmPay)}
    else{$('fl_hmrow').style.display='none';$('fl_hmpayrow').style.display='none'}
    $('fl_hold').textContent=fmt(f.holdCosts);$('fl_totalcost').textContent=fmt(f.totalCost);
    $('fl_arv').textContent=fmt(f.inp.arv);$('fl_sellcost').textContent=fmt(f.sellCosts);
    $('fl_proceeds').textContent=fmt(f.netProceeds);$('fl_profitline').textContent=fmt(f.profit);
    $('fl_cashin').textContent=fmt(f.cashInvested);$('fl_time').textContent=f.holdMo;
  }

  updatePF();buildSens();
  $('results').scrollIntoView({behavior:'smooth',block:'start'});
}

$('calcBtn').addEventListener('click',calculate,false);
$('calcBtn').addEventListener('touchend',function(e){e.preventDefault();calculate(e)},false);

// ─── Excel Download ──────────────────────────────────────────
function downloadExcel(e){
  if(e)e.preventDefault();
  if(!lastBH&&!lastBR){alert('Please calculate first.');return}
  var wb=XLSX.utils.book_new();
  var addr=getFullAddress();

  // Summary
  var s=[];
  s.push(['Quick Real Estate Analysis']);
  s.push(['Generated',new Date().toLocaleDateString()]);
  if(addr){
    s.push(['Property Address',addr]);
    s.push(['Street',$('addrStreet').value.trim(),'Unit',$('addrUnit').value.trim(),'City',$('addrCity').value.trim(),'State',$('addrState').value.trim().toUpperCase(),'ZIP',$('addrZip').value.trim()]);
  }
  s.push(['Units',numUnits]);s.push([]);
  saveUD();
  s.push(['UNIT DETAILS']);
  var rents=getRents();
  for(var i=0;i<numUnits;i++){var u=units[i];
    if(u.type==='ltr')s.push(['Unit '+(i+1)+' (LTR)','Monthly Rent',u.rent]);
    else s.push(['Unit '+(i+1)+' (STR)','Nightly',u.nightly,'Occ%',u.occ/100,'Monthly',rents[i],'Furnish',u.furnish]);
  }
  s.push(['Total Monthly Rent','',rents.reduce(function(a,b){return a+b},0)]);s.push([]);

  s.push(['DEAL INPUTS']);
  s.push(['Purchase Price',vl('purchasePrice')]);s.push(['Rehab Budget',getRehab()]);
  s.push(['ARV',vl('arv')]);s.push(['Monthly Insurance',vl('monthlyInsurance')]);
  s.push(['Monthly Tax',vl('monthlyTax')]);s.push(['Selling Costs',vl('sellCostPct')/100]);s.push([]);

  // Strategy comparison
  s.push(['STRATEGY COMPARISON','Buy & Hold','BRRRR','Flip']);
  s.push(['Cash Invested',lastBH?lastBH.totalCashIn:null,lastBR?lastBR.totalCashIn:null,lastFL?lastFL.cashInvested:null]);
  s.push(['Year 1 CoC Return',lastBH?lastBH.coc:null,lastBR?lastBR.coc:null,'N/A']);
  s.push(['10-Year IRR',lastBH?lastBH.irr:null,lastBR?lastBR.irr:null,'N/A']);
  s.push(['MOIC',lastBH?lastBH.moic:null,lastBR?lastBR.moic:null,'N/A']);
  s.push(['Flip ROI','N/A','N/A',lastFL?lastFL.roi:null]);
  s.push(['Flip Annualized ROI','N/A','N/A',lastFL?lastFL.annRoi:null]);
  s.push(['Flip Profit','N/A','N/A',lastFL?lastFL.profit:null]);

  var ws1=XLSX.utils.aoa_to_sheet(s);
  ws1['!cols']=[{wch:22},{wch:16},{wch:16},{wch:12},{wch:10},{wch:12},{wch:12},{wch:10},{wch:12}];
  XLSX.utils.book_append_sheet(wb,ws1,'Summary');

  // Pro Forma sheets
  function addPF(name,data){
    if(!data)return;
    var pf=[['10-Year Pro Forma — '+name+(addr?' — '+addr:'')],[]];
    pf.push(['Year','Eff. Rent','OpEx','NOI','Debt Service','Cash Flow','Prop Value','Loan Bal','Equity']);
    data.years.forEach(function(y){pf.push([y.yr,y.effRent,y.opex,y.noi,y.debtSvc,y.cf,y.propVal,y.remLoan,y.equity])});
    pf.push([]);pf.push(['Sale Proceeds (Yr 10)',data.years[9].saleProceeds]);
    var ws=XLSX.utils.aoa_to_sheet(pf);
    ws['!cols']=[{wch:8},{wch:14},{wch:16},{wch:14},{wch:14},{wch:14},{wch:14},{wch:14},{wch:14}];
    for(var r=3;r<13;r++)for(var c=1;c<=8;c++){var cl=XLSX.utils.encode_cell({r:r,c:c});if(ws[cl])ws[cl].z='$#,##0'}
    XLSX.utils.book_append_sheet(wb,ws,name+' Pro Forma');
  }
  addPF('Buy & Hold',lastBH);addPF('BRRRR',lastBR);

  // Flip sheet
  if(lastFL){
    var fl=[['Flip Analysis'+(addr?' — '+addr:'')],[]];
    fl.push(['Purchase Price',lastFL.inp.pp]);fl.push(['Rehab',lastFL.inp.rehab]);
    fl.push(['Closing Costs',lastFL.buyClose]);fl.push(['Holding Costs',lastFL.holdCosts]);
    if(useHM)fl.push(['HM Costs',lastFL.hmPts+lastFL.hmInt]);
    fl.push(['Total Cost',lastFL.totalCost]);fl.push([]);
    fl.push(['Sale Price (ARV)',lastFL.inp.arv]);fl.push(['Selling Costs',lastFL.sellCosts]);
    if(useHM)fl.push(['HM Payoff',lastFL.hmPay]);
    fl.push(['Net Proceeds',lastFL.netProceeds]);fl.push([]);
    fl.push(['Profit',lastFL.profit]);fl.push(['ROI',lastFL.roi]);fl.push(['Annualized ROI',lastFL.annRoi]);
    fl.push(['Hold Period (months)',lastFL.holdMo]);fl.push(['Cash Invested',lastFL.cashInvested]);
    var wsf=XLSX.utils.aoa_to_sheet(fl);wsf['!cols']=[{wch:22},{wch:16}];
    XLSX.utils.book_append_sheet(wb,wsf,'Flip');
  }

  var fn='RE_Analysis';
  var streetName=$('addrStreet').value.trim();
  if(streetName)fn=streetName.replace(/[^a-zA-Z0-9]/g,'_').replace(/_+/g,'_').substring(0,40);
  fn+='_'+new Date().toISOString().slice(0,10)+'.xlsx';
  XLSX.writeFile(wb,fn);
}
$('dlBtn').addEventListener('click',downloadExcel,false);
$('dlBtn').addEventListener('touchend',function(e){e.preventDefault();downloadExcel(e)},false);

// ─── Init ────────────────────────────────────────────────────
buildCards();
})();
</script>
</body>
</html>
