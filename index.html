<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Quick RE Analyzer">
<meta name="description" content="Free real estate deal analyzer. Compare Buy &amp; Hold, BRRRR, and Flip strategies side by side. Get Cash-on-Cash, IRR, MOIC, pro forma, and sensitivity analysis instantly — no signup required.">
<meta property="og:title" content="Quick Real Estate Analyzer — Free BRRRR, Buy &amp; Hold &amp; Flip Calculator">
<meta property="og:description" content="Analyze any real estate deal across 3 strategies in 60 seconds. Free, no signup required.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://quickreanalyzer.com">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%232C3437'/%3E%3Cpath d='M16 7L5 16h3v9h6v-6h4v6h6v-9h3L16 7z' fill='white'/%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='36' fill='%232C3437'/%3E%3Cpath d='M90 40L28 90h17v52h34v-34h22v34h34V90h17L90 40z' fill='white'/%3E%3C/svg%3E">
<link rel="canonical" href="https://quickreanalyzer.com">
<title>Quick Real Estate Analyzer — Free BRRRR, Buy &amp; Hold &amp; Flip Calculator</title>
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebApplication","name":"Quick Real Estate Analyzer","url":"https://quickreanalyzer.com","description":"Free real estate deal analyzer comparing Buy & Hold, BRRRR, and Flip strategies with Cash-on-Cash, IRR, MOIC, pro forma, and sensitivity analysis.","applicationCategory":"FinanceApplication","operatingSystem":"Any","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"},"browserRequirements":"Requires JavaScript"}
</script>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:Georgia,'Times New Roman',serif;background:#F2EDE3;min-height:100vh;margin:0 auto;cursor:pointer;color:#2C3437}
.nav{background:#2C3437;padding:0 20px;position:sticky;top:0;z-index:20}
.nav-inner{max-width:960px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;height:52px}
.nav-brand{color:#F2EDE3;font-size:15px;font-weight:700;text-decoration:none;letter-spacing:1px;text-transform:uppercase;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.nav-links{display:flex;gap:24px;list-style:none}
.nav-links a{color:#B5A99A;font-size:12px;font-weight:600;text-decoration:none;transition:color 0.2s;letter-spacing:0.5px;text-transform:uppercase;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.nav-links a:hover,.nav-links a.active{color:#F2EDE3}
.nav-toggle{display:none;background:none;border:none;color:#F2EDE3;font-size:22px;cursor:pointer;padding:4px}
.hero{background:#2C3437;padding:56px 20px;text-align:center;color:#F2EDE3}
.hero-inner{max-width:680px;margin:0 auto}
.hero h1{font-size:30px;font-weight:400;letter-spacing:-0.3px;line-height:1.4;margin-bottom:16px;font-family:Georgia,'Times New Roman',serif}
.hero p{font-size:15px;opacity:0.8;line-height:1.7;margin-bottom:28px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.hero-features{display:flex;justify-content:center;gap:28px;flex-wrap:wrap;margin-bottom:32px}
.hero-feat{font-size:12px;font-weight:600;opacity:0.7;letter-spacing:0.5px;text-transform:uppercase;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.hero-cta{display:inline-block;background:#F2EDE3;color:#2C3437;padding:14px 36px;border-radius:4px;font-weight:700;font-size:13px;text-decoration:none;letter-spacing:0.5px;text-transform:uppercase;transition:all 0.2s;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.hero-cta:hover{background:#fff;transform:translateY(-1px)}
.header{background:#546070;padding:18px 20px 14px;color:#F2EDE3}
.header-inner{max-width:960px;margin:0 auto}
.header h1{font-size:20px;font-weight:400;letter-spacing:0.5px}
.header p{font-size:12px;opacity:0.7;margin-top:2px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.content{padding:20px 16px 60px;max-width:960px;margin:0 auto}
.desktop-layout{display:flex;gap:24px;align-items:flex-start}
.desktop-left{flex:1;min-width:0}
.desktop-right{flex:1;min-width:0;position:sticky;top:72px;max-height:calc(100vh - 84px);overflow-y:auto}
.footer{background:#2C3437;color:#B5A99A;padding:36px 20px;margin-top:40px;font-size:13px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.footer-inner{max-width:960px;margin:0 auto;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:24px}
.footer-col h4{color:#F2EDE3;font-size:13px;font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
.footer-col a{color:#B5A99A;text-decoration:none;display:block;line-height:2}
.footer-col a:hover{color:#F2EDE3}
.footer-copy{max-width:960px;margin:16px auto 0;padding-top:16px;border-top:1px solid #43474B;font-size:11px;color:#7B7368}
.share-btn{background:#546070;box-shadow:none}.share-btn:active{background:#43474B}
.share-toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#5C7A61;color:#F2EDE3;padding:10px 24px;border-radius:4px;font-size:13px;font-weight:600;opacity:0;transition:opacity 0.3s;pointer-events:none;z-index:100;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.share-toast.show{opacity:1}
.email-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(44,52,55,0.6);z-index:50;align-items:center;justify-content:center}
.email-overlay.show{display:flex}
.email-modal{background:#F9F5EC;border-radius:8px;padding:28px;max-width:380px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.25)}
.email-modal h3{font-size:18px;font-weight:400;color:#2C3437;margin-bottom:6px;font-family:Georgia,'Times New Roman',serif}
.email-modal p{font-size:13px;color:#5B6568;margin-bottom:16px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.email-modal input[type="email"]{width:100%;padding:12px;border:1px solid #D4C9B5;border-radius:4px;font-size:15px;font-family:inherit;margin-bottom:12px;outline:none;background:#fff}
.email-modal input[type="email"]:focus{border-color:#546070;box-shadow:0 0 0 3px rgba(84,96,112,0.1)}
.email-submit{width:100%;padding:12px;background:#546070;color:#F2EDE3;border:none;border-radius:4px;font-size:13px;font-weight:700;cursor:pointer;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;margin-bottom:8px;letter-spacing:0.5px;text-transform:uppercase}
.email-skip{display:block;width:100%;text-align:center;background:none;border:none;color:#B5A99A;font-size:13px;cursor:pointer;padding:8px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.save-notice{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#5C7A61;color:#F2EDE3;padding:8px 20px;border-radius:4px;font-size:13px;font-weight:600;opacity:0;transition:opacity 0.3s;pointer-events:none;z-index:100;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.save-notice.show{opacity:1}
@media(max-width:768px){
  .content{max-width:480px}
  .desktop-layout{flex-direction:column}
  .desktop-right{position:static;max-height:none;overflow-y:visible}
  .hero h1{font-size:24px}
  .hero p{font-size:14px}
  .hero{padding:36px 16px}
  .nav-links{display:none;position:absolute;top:52px;left:0;right:0;background:#2C3437;flex-direction:column;padding:12px 20px;gap:0;border-top:1px solid #43474B}
  .nav-links.open{display:flex}
  .nav-links a{padding:10px 0;display:block}
  .nav-toggle{display:block}
  .footer-inner{flex-direction:column;gap:16px}
}
.section{margin-bottom:16px}
.sec-btn{display:flex;justify-content:space-between;align-items:center;width:100%;padding:10px 0;background:none;border:none;cursor:pointer;-webkit-appearance:none;appearance:none;font-family:inherit;touch-action:manipulation}
.sec-btn span:first-child{font-size:15px;font-weight:700;color:#2C3437;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.arrow{font-size:18px;color:#B5A99A;transition:transform 0.2s;display:inline-block}
.sec-body{overflow:hidden;max-height:0;transition:max-height 0.3s ease}
.sec-body.open{max-height:8000px}
.field{margin-bottom:12px}
.field label{display:block;font-size:12px;font-weight:600;color:#2C3437;margin-bottom:4px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;text-transform:uppercase;letter-spacing:0.3px}
.help{font-weight:400;color:#B5A99A;margin-left:6px;font-size:11px;text-transform:none;letter-spacing:0}
.iw{display:flex;align-items:center;border:1px solid #D4C9B5;border-radius:4px;overflow:hidden;background:#fff}
.iw .pre{padding:8px 0 8px 12px;color:#B5A99A;font-size:15px;user-select:none}
.iw input[type="number"],.iw input[type="text"]{flex:1;border:none;outline:none;padding:10px 8px;font-size:16px;background:transparent;width:100%;min-width:0;-webkit-appearance:none;appearance:none;border-radius:0;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.iw .suf{padding:8px 12px 8px 0;color:#B5A99A;font-size:13px;user-select:none;white-space:nowrap}
.tog-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.tog-row span{font-size:12px;font-weight:600;color:#2C3437;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;text-transform:uppercase;letter-spacing:0.3px}
.tog-btn{width:48px;height:28px;border-radius:14px;padding:2px;cursor:pointer;background:#D4C9B5;transition:background 0.2s;position:relative;flex-shrink:0;border:none;-webkit-appearance:none;appearance:none;touch-action:manipulation}
.tog-btn.on{background:#546070}
.tog-k{width:24px;height:24px;border-radius:12px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.15);transition:transform 0.2s;pointer-events:none}
.tog-btn.on .tog-k{transform:translateX(20px)}
.hm-fields{display:none}.hm-fields.show{display:block}
.action-btn{display:block;width:100%;color:#F2EDE3;text-align:center;padding:14px 20px;border-radius:4px;cursor:pointer;font-weight:700;font-size:12px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;margin-bottom:12px;border:none;-webkit-appearance:none;appearance:none;touch-action:manipulation;letter-spacing:0.5px;text-transform:uppercase}
.calc-btn{background:#5C7A61;box-shadow:none}.calc-btn:active{background:#4A6650}
.pf-btn{background:#546070;box-shadow:none}.pf-btn:active{background:#43474B}
.dl-btn{background:#2C3437;box-shadow:none}.dl-btn:active{background:#1D2224}
.pdf-btn{background:#546070;box-shadow:none}.pdf-btn:active{background:#43474B}
.export-row{display:flex;gap:10px;margin-bottom:12px}.export-row .action-btn{flex:1;margin-bottom:0}
.sa-btn{background:#8B7355;box-shadow:none}.sa-btn:active{background:#7A6449}
.mg{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px}
.mc{background:#F9F5EC;border-radius:8px;padding:16px 14px;flex:1 1 45%;min-width:140px;box-shadow:none;border:1px solid #E8E3D8}
.ml{font-size:11px;color:#7B7368;font-weight:600;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.mv{font-size:22px;font-weight:700;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.ms{font-size:11px;color:#B5A99A;margin-top:2px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.card{background:#F9F5EC;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:none;border:1px solid #E8E3D8}
.ct{font-size:14px;font-weight:700;color:#2C3437;margin-bottom:10px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.row{display:flex;justify-content:space-between;font-size:13px;color:#5B6568;line-height:1.8;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.row .v{font-weight:600}
.divr{border-top:1px solid #E8E3D8;padding-top:6px;margin-top:6px}
.hlr{display:flex;justify-content:space-between;background:#2C3437;margin:8px -16px -16px;padding:10px 16px;border-radius:0 0 8px 8px;font-weight:700;font-size:14px;color:#F2EDE3;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.pfw{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:620px}
th{padding:8px 6px;text-align:right;font-weight:700;color:#2C3437;white-space:nowrap;border-bottom:2px solid #D4C9B5;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;font-size:11px}
td{padding:6px;text-align:right;border-bottom:1px solid #E8E3D8;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;font-size:12px}
td.yr{text-align:center;font-weight:700;color:#7B7368}
.pfn{font-size:11px;color:#B5A99A;margin-top:8px;text-align:center;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.grn{color:#5C7A61}.red{color:#A4574B}.blu{color:#546070}.amb{color:#8B7355}
#results{display:none}#results.show{display:block}
.unit-card{background:#F9F5EC;border:1px solid #E8E3D8;border-radius:8px;padding:12px;margin-bottom:10px}
.unit-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.unit-hdr span{font-size:14px;font-weight:700;color:#2C3437;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.type-toggle{display:flex;border-radius:4px;overflow:hidden;border:1px solid #D4C9B5}
.type-opt{padding:6px 12px;font-size:12px;font-weight:600;cursor:pointer;background:#F9F5EC;color:#7B7368;border:none;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;-webkit-appearance:none;appearance:none;touch-action:manipulation}
.type-opt.active{background:#546070;color:#F2EDE3}
.unit-fields{margin-top:4px}
.unit-fields-row{display:flex;gap:8px}
.unit-fields-row .field{flex:1;margin-bottom:8px}
.unit-stepper{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.step-btn{width:36px;height:36px;border-radius:18px;border:2px solid #D4C9B5;background:#F9F5EC;font-size:20px;font-weight:700;color:#2C3437;cursor:pointer;display:flex;align-items:center;justify-content:center;-webkit-appearance:none;appearance:none;touch-action:manipulation;font-family:inherit;line-height:1}
.step-btn:active{background:#E8E3D8}
.unit-count{font-size:18px;font-weight:700;color:#2C3437;min-width:30px;text-align:center;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.addr-input{width:100%;border:1px solid #D4C9B5;border-radius:4px;padding:10px 12px;font-size:16px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;background:#fff;-webkit-appearance:none;appearance:none;outline:none}
.addr-input:focus{border-color:#546070;box-shadow:0 0 0 3px rgba(84,96,112,0.1)}
.rehab-toggle,.strat-tabs{display:flex;border-radius:4px;overflow:hidden;border:1px solid #D4C9B5;margin-bottom:12px}
.rehab-opt{padding:8px 14px;font-size:12px;font-weight:600;cursor:pointer;background:#F9F5EC;color:#7B7368;border:none;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;flex:1;text-align:center;-webkit-appearance:none;appearance:none;touch-action:manipulation;text-transform:uppercase;letter-spacing:0.3px}
.rehab-opt.active{background:#546070;color:#F2EDE3}
.strat-tabs{margin-bottom:16px;border:2px solid #2C3437}
.strat-tab{padding:10px 8px;font-size:12px;font-weight:700;cursor:pointer;background:#F9F5EC;color:#7B7368;border:none;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;flex:1;text-align:center;-webkit-appearance:none;appearance:none;touch-action:manipulation;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.3px}
.strat-tab.active{background:#2C3437;color:#F2EDE3}
.strat-panel{display:none}.strat-panel.active{display:block}
.sens-tbl{width:100%;border-collapse:collapse;font-size:11px;min-width:auto}
.sens-tbl th{padding:6px 4px;text-align:center;font-size:10px;border-bottom:2px solid #E8E3D8;white-space:nowrap}
.sens-tbl td{padding:5px 4px;text-align:center;border-bottom:1px solid #F2EDE3;font-weight:600}
.sens-tbl td.base{background:#E8E3D8;font-weight:800}
.sens-tbl td:first-child{text-align:left;font-weight:700;color:#7B7368;font-size:10px}
.io-label{font-size:11px;color:#B5A99A;font-style:italic;margin-top:-4px;margin-bottom:8px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.str-calc{font-size:12px;color:#5C7A61;font-weight:700;padding:4px 0 4px 0;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.flip-profit{font-size:28px;font-weight:800;text-align:center;margin:8px 0;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.addr-row{display:flex;gap:8px}
.addr-row .field{flex:1;margin-bottom:8px}
.addr-err{border-color:#A4574B !important;box-shadow:0 0 0 3px rgba(164,87,75,0.12) !important}
.err-msg{font-size:11px;color:#A4574B;font-weight:600;margin-bottom:8px;display:none;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.err-msg.show{display:block}
.req{color:#A4574B;margin-left:2px}
.lookup-btn{display:block;width:100%;padding:10px;background:#F9F5EC;border:1px solid #D4C9B5;border-radius:4px;color:#546070;font-size:12px;font-weight:700;cursor:pointer;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;margin-bottom:12px;transition:all 0.2s;-webkit-appearance:none;appearance:none;touch-action:manipulation;letter-spacing:0.3px;text-transform:uppercase}
.lookup-btn:hover{background:#E8E3D8}
.lookup-btn:active{background:#D4C9B5}
.lookup-btn:disabled{opacity:0.5;cursor:not-allowed}
.lookup-note{font-size:11px;color:#B5A99A;font-style:italic;margin:-4px 0 12px;line-height:1.4;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.lookup-result{font-size:12px;color:#5C7A61;font-weight:600;margin:-4px 0 12px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
.lookup-err{font-size:12px;color:#A4574B;font-weight:600;margin:-4px 0 12px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif}
</style>
</head>
<body ontouchstart="">

<nav class="nav">
  <div class="nav-inner">
    <a href="/" class="nav-brand">Quick RE Analyzer</a>
    <button type="button" class="nav-toggle" id="navToggle" aria-label="Menu">&#9776;</button>
    <div class="nav-links" id="navLinks">
      <a href="/" class="active">Home</a>
      <a href="#calculator">Calculator</a>
      <a href="/blog/how-to-analyze-brrrr-deal.html">Blog</a>
      <a href="/about.html">About</a>
    </div>
  </div>
</nav>

<section class="hero">
  <div class="hero-inner">
    <h1>Analyze Any Real Estate Deal Across 3 Strategies in 60 Seconds</h1>
    <p>Compare Buy &amp; Hold, BRRRR, and Flip side by side with Cash-on-Cash, IRR, MOIC, 10-year pro forma, and sensitivity analysis. Free, no signup required.</p>
    <div class="hero-features">
      <span class="hero-feat">&#10003; 3 Strategies</span>
      <span class="hero-feat">&#10003; 10-Year Pro Forma</span>
      <span class="hero-feat">&#10003; Sensitivity Analysis</span>
      <span class="hero-feat">&#10003; Excel Export</span>
    </div>
    <a href="#calculator" class="hero-cta">Start Your Analysis</a>
  </div>
</section>

<div id="shareToast" class="share-toast">Link copied to clipboard!</div>
<div id="saveNotice" class="save-notice">Inputs saved</div>

<div class="header" id="calculator">
  <div class="header-inner">
    <h1>Quick Real Estate Analyzer</h1>
    <p>Buy &amp; Hold &middot; BRRRR &middot; Flip</p>
  </div>
</div>

<div class="content">
<div class="desktop-layout">
<div class="desktop-left">

  <!-- ═══ PROPERTY INFO ═══ -->
  <div class="section">
    <button type="button" class="sec-btn" id="secPropBtn">
      <span>Property Info</span><span class="arrow" id="arrowProp" style="transform:rotate(90deg)">›</span>
    </button>
    <div class="sec-body open" id="secProp">
      <div class="err-msg" id="addrErr">Please fill in all address fields before calculating.</div>
      <div class="field">
        <label>Street Address<span class="req">*</span></label>
        <input type="text" class="addr-input" id="addrStreet" placeholder="123 Main St">
      </div>
      <div class="field">
        <label>Unit / Apt <span class="help">(optional)</span></label>
        <input type="text" class="addr-input" id="addrUnit" placeholder="Apt 2B">
      </div>
      <div class="addr-row">
        <div class="field" style="flex:2">
          <label>City<span class="req">*</span></label>
          <input type="text" class="addr-input" id="addrCity" placeholder="City">
        </div>
        <div class="field" style="flex:1">
          <label>State<span class="req">*</span></label>
          <input type="text" class="addr-input" id="addrState" placeholder="ST" maxlength="2" style="text-transform:uppercase">
        </div>
      </div>
      <div class="field" style="max-width:160px">
        <label>ZIP Code<span class="req">*</span></label>
        <input type="text" class="addr-input" id="addrZip" placeholder="12345" inputmode="numeric" maxlength="10">
      </div>
      <div class="field">
        <label>Number of Units</label>
        <div class="unit-stepper">
          <button type="button" class="step-btn" id="unitMinus">−</button>
          <span class="unit-count" id="unitCount">1</span>
          <button type="button" class="step-btn" id="unitPlus">+</button>
        </div>
      </div>
      <div id="unitCards"></div>
    </div>
  </div>

  <!-- ═══ DEAL INPUTS ═══ -->
  <div class="section">
    <button type="button" class="sec-btn" id="secDealBtn">
      <span>Deal Inputs</span><span class="arrow" id="arrowDeal" style="transform:rotate(90deg)">›</span>
    </button>
    <div class="sec-body open" id="secDeal">
      <div class="field"><label>Purchase Price</label>
        <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="purchasePrice" value="120000" step="1000"></div></div>
      <div class="field"><label>Rehab Budget</label></div>
      <div class="rehab-toggle" id="rehabToggle">
        <button type="button" class="rehab-opt active" data-mode="total">Total Cost</button>
        <button type="button" class="rehab-opt" data-mode="sqft">Per Sq Ft</button>
      </div>
      <div id="rehabTotal">
        <div class="field"><div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="rehabBudget" value="30000" step="1000"></div></div>
      </div>
      <div id="rehabSqft" style="display:none">
        <div class="field"><label>Square Footage</label>
          <div class="iw"><input type="number" inputmode="decimal" id="sqft" value="1200" step="100"><span class="suf">sq ft</span></div></div>
        <div class="field"><label>Cost per Sq Ft</label>
          <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="costPerSqft" value="25" step="1"><span class="suf">/sq ft</span></div></div>
        <div class="io-label">Calculated rehab: <span id="calcRehab">$30,000</span></div>
      </div>
      <div class="field"><label>After Repair Value (ARV)</label>
        <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="arv" value="200000" step="1000"></div></div>
      <button type="button" class="lookup-btn" id="lookupBtn">&#128269; Estimate Tax &amp; Insurance (State Average)</button>
      <div id="lookupStatus"></div>
      <div class="field"><label>Monthly Insurance</label>
        <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="monthlyInsurance" value="150" step="10"></div></div>
      <div class="field"><label>Monthly Property Tax</label>
        <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="monthlyTax" value="200" step="10"></div></div>
      <div class="field"><label>Selling Costs <span class="help">agent + closing</span></label>
        <div class="iw"><input type="number" inputmode="decimal" id="sellCostPct" value="6" step="0.5"><span class="suf">%</span></div></div>
    </div>
  </div>

  <!-- ═══ FINANCING ═══ -->
  <div class="section">
    <button type="button" class="sec-btn" id="secFinBtn">
      <span>Financing</span><span class="arrow" id="arrowFin">›</span>
    </button>
    <div class="sec-body" id="secFin">
      <div style="font-size:12px;font-weight:700;color:#7B7368;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif">Buy &amp; Hold Loan</div>
      <div class="field"><label>Down Payment</label>
        <div class="iw"><input type="number" inputmode="decimal" id="downPct" value="20" step="1"><span class="suf">%</span></div></div>
      <div class="field"><label>Mortgage Rate</label>
        <div class="iw"><input type="number" inputmode="decimal" id="bhRate" value="7.0" step="0.1"><span class="suf">%</span></div></div>
      <div class="field"><label>Loan Term</label>
        <div class="iw"><input type="number" inputmode="decimal" id="bhTermYears" value="30" step="1"><span class="suf">years</span></div></div>

      <div style="border-top:1px solid #E8E3D8;margin:16px 0;padding-top:16px">
        <div style="font-size:12px;font-weight:700;color:#7B7368;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif">BRRRR Refinance</div>
      </div>
      <div class="field"><label>Refinance Rate</label>
        <div class="iw"><input type="number" inputmode="decimal" id="refiRate" value="7.0" step="0.1"><span class="suf">%</span></div></div>
      <div class="field"><label>Refinance LTV</label>
        <div class="iw"><input type="number" inputmode="decimal" id="refiLtv" value="75" step="1"><span class="suf">%</span></div></div>
      <div class="field"><label>Refi Loan Term</label>
        <div class="iw"><input type="number" inputmode="decimal" id="refiTermYears" value="30" step="1"><span class="suf">years</span></div></div>
      <div class="tog-row">
        <span>Interest-Only Period</span>
        <button type="button" class="tog-btn" id="ioToggle"><div class="tog-k"></div></button>
      </div>
      <div id="ioFields" style="display:none">
        <div class="field"><label>I/O Period</label>
          <div class="iw"><input type="number" inputmode="decimal" id="ioYears" value="3" step="1"><span class="suf">years</span></div></div>
        <div class="io-label">Loan amortizes fully after I/O period</div>
      </div>

      <div style="border-top:1px solid #E8E3D8;margin:16px 0;padding-top:16px">
        <div style="font-size:12px;font-weight:700;color:#7B7368;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif">Acquisition (BRRRR/Flip)</div>
      </div>
      <div class="tog-row">
        <span>Use Hard Money / Bridge Loan</span>
        <button type="button" class="tog-btn" id="hmToggle"><div class="tog-k"></div></button>
      </div>
      <div class="hm-fields" id="hmFields">
        <div class="field"><label>Hard Money Rate</label>
          <div class="iw"><input type="number" inputmode="decimal" id="hmRate" value="12" step="0.1"><span class="suf">%</span></div></div>
        <div class="field"><label>Origination Points</label>
          <div class="iw"><input type="number" inputmode="decimal" id="hmPoints" value="2" step="0.5"><span class="suf">%</span></div></div>
        <div class="field"><label>Loan-to-Cost (LTC)</label>
          <div class="iw"><input type="number" inputmode="decimal" id="hmLtc" value="85" step="1"><span class="suf">%</span></div></div>
        <div class="field"><label>Loan Term</label>
          <div class="iw"><input type="number" inputmode="decimal" id="hmTermMonths" value="12" step="1"><span class="suf">months</span></div></div>
      </div>

      <div style="border-top:1px solid #E8E3D8;margin:16px 0;padding-top:16px">
        <div style="font-size:12px;font-weight:700;color:#7B7368;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif">Flip Timeline</div>
      </div>
      <div class="field"><label>Holding Period</label>
        <div class="iw"><input type="number" inputmode="decimal" id="flipHoldMonths" value="6" step="1"><span class="suf">months</span></div></div>
      <div class="field"><label>Monthly Holding Costs <span class="help">utils, lawn, etc.</span></label>
        <div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" id="flipHoldCostMo" value="500" step="50"></div></div>
    </div>
  </div>

  <!-- ═══ ASSUMPTIONS ═══ -->
  <div class="section">
    <button type="button" class="sec-btn" id="secAssBtn">
      <span>Assumptions</span><span class="arrow" id="arrowAss">›</span>
    </button>
    <div class="sec-body" id="secAss">
      <div class="field"><label>Closing Costs <span class="help">of loan/purchase</span></label>
        <div class="iw"><input type="number" inputmode="decimal" id="closingCostPct" value="3" step="0.5"><span class="suf">%</span></div></div>
      <div class="field"><label>Vacancy Rate</label>
        <div class="iw"><input type="number" inputmode="decimal" id="vacancyPct" value="5" step="1"><span class="suf">%</span></div></div>
      <div class="field"><label>Property Management <span class="help">of eff. rent</span></label>
        <div class="iw"><input type="number" inputmode="decimal" id="mgmtPct" value="8" step="1"><span class="suf">%</span></div></div>
      <div class="field"><label>CapEx / Maintenance <span class="help">of eff. rent</span></label>
        <div class="iw"><input type="number" inputmode="decimal" id="capexPct" value="5" step="1"><span class="suf">%</span></div></div>
      <div class="field"><label>Annual Rent Growth</label>
        <div class="iw"><input type="number" inputmode="decimal" id="rentGrowth" value="3" step="0.5"><span class="suf">%</span></div></div>
      <div class="field"><label>Annual Appreciation</label>
        <div class="iw"><input type="number" inputmode="decimal" id="appreciation" value="3" step="0.5"><span class="suf">%</span></div></div>
    </div>
  </div>

  <button type="button" class="action-btn calc-btn" id="calcBtn">Calculate All Strategies</button>

</div><!-- end desktop-left -->
<div class="desktop-right">

  <!-- ═══ RESULTS ═══ -->
  <div id="results">

    <!-- Strategy Tabs -->
    <div class="strat-tabs" id="stratTabs">
      <button type="button" class="strat-tab active" data-strat="bh">Buy &amp; Hold</button>
      <button type="button" class="strat-tab" data-strat="brrrr">BRRRR</button>
      <button type="button" class="strat-tab" data-strat="flip">Flip</button>
    </div>

    <!-- ── BUY & HOLD ── -->
    <div class="strat-panel active" id="panel_bh">
      <div class="mg">
        <div class="mc"><div class="ml">Cash-on-Cash</div><div class="mv" id="bh_coc">—</div><div class="ms">Year 1</div></div>
        <div class="mc"><div class="ml">10-Year IRR</div><div class="mv" id="bh_irr">—</div><div class="ms">Incl. sale</div></div>
        <div class="mc"><div class="ml">MOIC</div><div class="mv" id="bh_moic">—</div><div class="ms">10-year</div></div>
        <div class="mc"><div class="ml">Mo. Cash Flow</div><div class="mv" id="bh_mcf">—</div><div class="ms">Year 1</div></div>
      </div>
      <div class="card">
        <div class="ct">Buy &amp; Hold Capital Stack</div>
        <div class="row"><span>Purchase Price</span><span class="v" id="bh_pp">—</span></div>
        <div class="row"><span>+ Rehab</span><span class="v" id="bh_rehab">—</span></div>
        <div class="row"><span>+ Furnishing (STR)</span><span class="v" id="bh_furn">—</span></div>
        <div class="row"><span>+ Closing Costs</span><span class="v" id="bh_close">—</span></div>
        <div class="row divr" style="font-weight:700"><span>Down Payment</span><span class="v" id="bh_down">—</span></div>
        <div class="row"><span>Loan Amount</span><span class="v" id="bh_loan">—</span></div>
        <div class="hlr"><span>Total Cash Invested</span><span id="bh_cashin">—</span></div>
      </div>
      <div class="card">
        <div class="ct">Monthly Cash Flow (Year 1)</div>
        <div id="bh_unit_rents"></div>
        <div class="row"><span>Total Gross Rent</span><span class="v" id="bh_gross">—</span></div>
        <div class="row"><span>− Vacancy</span><span class="v" id="bh_vac">—</span></div>
        <div class="row"><span>− Insurance</span><span class="v" id="bh_ins">—</span></div>
        <div class="row"><span>− Taxes</span><span class="v" id="bh_tax">—</span></div>
        <div class="row"><span>− Management</span><span class="v" id="bh_mgmt">—</span></div>
        <div class="row"><span>− CapEx Reserve</span><span class="v" id="bh_capex">—</span></div>
        <div class="row"><span>− Mortgage</span><span class="v" id="bh_mort">—</span></div>
        <div class="row divr" style="font-weight:700;font-size:14px"><span>Net Cash Flow</span><span class="v" id="bh_ncf">—</span></div>
      </div>
    </div>

    <!-- ── BRRRR ── -->
    <div class="strat-panel" id="panel_brrrr">
      <div class="mg">
        <div class="mc"><div class="ml">Cash-on-Cash</div><div class="mv" id="br_coc">—</div><div class="ms">Year 1, levered</div></div>
        <div class="mc"><div class="ml">Unlevered CoC</div><div class="mv" id="br_unlev">—</div><div class="ms">Year 1</div></div>
        <div class="mc"><div class="ml">10-Year IRR</div><div class="mv" id="br_irr">—</div><div class="ms">Incl. sale</div></div>
        <div class="mc"><div class="ml">MOIC</div><div class="mv" id="br_moic">—</div><div class="ms">10-year</div></div>
      </div>
      <div class="card">
        <div class="ct">BRRRR Capital Stack</div>
        <div class="row"><span>Total Project Cost</span><span class="v" id="br_tpc">—</span></div>
        <div class="row"><span>+ Furnishing (STR)</span><span class="v" id="br_furn">—</span></div>
        <div class="row" id="br_hmrow" style="display:none"><span>+ HM Points &amp; Interest</span><span class="v" id="br_hmcost">—</span></div>
        <div class="row"><span>+ Purchase Closing</span><span class="v" id="br_pclose">—</span></div>
        <div class="row divr" style="font-weight:700"><span>Total Cash Out</span><span class="v" id="br_cashout">—</span></div>
        <div class="row"><span>Refi Loan Amount</span><span class="v" id="br_refiloan">—</span></div>
        <div class="row"><span>− Refi Closing</span><span class="v" id="br_reficlose">—</span></div>
        <div class="row" id="br_hmpayrow" style="display:none"><span>− HM Payoff</span><span class="v" id="br_hmpay">—</span></div>
        <div class="row"><span>= Cash Back at Refi</span><span class="v grn" id="br_cashback">—</span></div>
        <div class="hlr"><span>Cash Left in Deal</span><span id="br_cashin">—</span></div>
      </div>
      <div class="card">
        <div class="ct">Monthly Cash Flow (Year 1)</div>
        <div id="br_unit_rents"></div>
        <div class="row"><span>Total Gross Rent</span><span class="v" id="br_gross">—</span></div>
        <div class="row"><span>− Vacancy</span><span class="v" id="br_vac">—</span></div>
        <div class="row"><span>− Insurance</span><span class="v" id="br_ins">—</span></div>
        <div class="row"><span>− Taxes</span><span class="v" id="br_tax">—</span></div>
        <div class="row"><span>− Management</span><span class="v" id="br_mgmt">—</span></div>
        <div class="row"><span>− CapEx Reserve</span><span class="v" id="br_capex">—</span></div>
        <div class="row"><span>− Mortgage</span><span class="v" id="br_mort">—</span></div>
        <div class="row" id="br_iolabel" style="display:none;color:#8B7355;font-style:italic"><span></span><span class="v"></span></div>
        <div class="row divr" style="font-weight:700;font-size:14px"><span>Net Cash Flow</span><span class="v" id="br_ncf">—</span></div>
      </div>
    </div>

    <!-- ── FLIP ── -->
    <div class="strat-panel" id="panel_flip">
      <div class="card" style="text-align:center;background:#E8E3D8;border-color:#D4C9B5">
        <div class="ml" style="text-align:center">Estimated Flip Profit</div>
        <div class="flip-profit" id="fl_profit">—</div>
        <div style="display:flex;justify-content:center;gap:20px;margin-top:8px">
          <div><div class="ml">ROI</div><div style="font-size:18px;font-weight:700" id="fl_roi">—</div></div>
          <div><div class="ml">Annualized</div><div style="font-size:18px;font-weight:700" id="fl_aroi">—</div></div>
        </div>
      </div>
      <div class="card">
        <div class="ct">Flip Breakdown</div>
        <div class="row"><span>Purchase Price</span><span class="v" id="fl_pp">—</span></div>
        <div class="row"><span>+ Rehab</span><span class="v" id="fl_rehab">—</span></div>
        <div class="row"><span>+ Purchase Closing</span><span class="v" id="fl_bclose">—</span></div>
        <div class="row" id="fl_hmrow" style="display:none"><span>+ HM Points &amp; Interest</span><span class="v" id="fl_hmcost">—</span></div>
        <div class="row"><span>+ Holding Costs</span><span class="v" id="fl_hold">—</span></div>
        <div class="row divr" style="font-weight:700"><span>Total Cost</span><span class="v" id="fl_totalcost">—</span></div>
        <div style="height:8px"></div>
        <div class="row"><span>Sale Price (ARV)</span><span class="v" id="fl_arv">—</span></div>
        <div class="row"><span>− Selling Costs</span><span class="v" id="fl_sellcost">—</span></div>
        <div class="row" id="fl_hmpayrow" style="display:none"><span>− HM Loan Payoff</span><span class="v" id="fl_hmpay">—</span></div>
        <div class="row divr" style="font-weight:700"><span>Net Proceeds</span><span class="v" id="fl_proceeds">—</span></div>
        <div class="hlr"><span>Profit</span><span id="fl_profitline">—</span></div>
      </div>
      <div class="mg">
        <div class="mc"><div class="ml">Cash Invested</div><div class="mv blu" id="fl_cashin">—</div><div class="ms">Out of pocket</div></div>
        <div class="mc"><div class="ml">Hold Time</div><div class="mv blu" id="fl_time">—</div><div class="ms">Months</div></div>
      </div>
    </div>

    <!-- Shared: Pro Forma (Buy&Hold / BRRRR) -->
    <div id="pfSection">
      <button type="button" class="action-btn pf-btn" id="pfToggle">Show 10-Year Pro Forma</button>
      <div class="card" id="pfCard" style="display:none">
        <div class="ct" id="pfTitle">10-Year Pro Forma</div>
        <div class="pfw">
          <table><thead><tr><th>Yr</th><th>Eff. Rent</th><th>OpEx</th><th>NOI</th><th>Debt Svc</th><th>Cash Flow</th><th>Prop Value</th><th>Loan Bal</th><th>Equity</th></tr></thead>
          <tbody id="pfBody"></tbody></table>
        </div>
        <div class="pfn" id="pfNote"></div>
      </div>
    </div>

    <button type="button" class="action-btn sa-btn" id="saToggle">Show Sensitivity Analysis</button>
    <div class="card" id="saCard" style="display:none">
      <div class="ct" id="saCocTitle">Sensitivity: Cash-on-Cash Return</div>
      <div class="pfw"><table class="sens-tbl" id="saCocTbl"></table></div>
      <div style="height:16px"></div>
      <div class="ct" id="saIrrTitle">Sensitivity: 10-Year IRR</div>
      <div class="pfw"><table class="sens-tbl" id="saIrrTbl"></table></div>
      <div class="pfn">Rows = vacancy shifts, Columns = rent shifts from base</div>
    </div>

    <div class="export-row">
      <button type="button" class="action-btn dl-btn" id="dlBtn">Export Excel</button>
      <button type="button" class="action-btn pdf-btn" id="pdfBtn">Export PDF</button>
    </div>
    <button type="button" class="action-btn share-btn" id="shareBtn">Share This Analysis</button>

    <div style="margin-top:20px;padding:16px;background:#E8E3D8;border:1px solid #D4C9B5;border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#2C3437;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif">Important Disclaimer</div>
      <div style="font-size:11px;color:#5B6568;line-height:1.6;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif">This tool is for <strong>informational and educational purposes only</strong> and does not constitute financial, investment, legal, tax, or real estate advice. All projections are hypothetical estimates based on user inputs.</div>
      <button type="button" class="action-btn" id="discBtn" style="background:#43474B;font-size:11px;padding:10px;margin-top:8px;margin-bottom:0">Read Full Disclaimer</button>
      <div id="discFull" style="display:none;margin-top:10px;font-size:11px;color:#5B6568;line-height:1.6;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif">
        <p style="margin-bottom:8px"><strong>No Warranty.</strong> Projections including CoC, IRR, MOIC, NOI, and all pro forma outputs are estimates only. Actual results will vary materially. Past performance is not indicative of future results.</p>
        <p style="margin-bottom:8px"><strong>Not Professional Advice.</strong> Consult licensed real estate agents, CPAs, financial advisors, and attorneys before making investment decisions. The creators are not licensed professionals.</p>
        <p style="margin-bottom:8px"><strong>Assumption Limitations.</strong> Projections may not reflect actual market conditions. The tool does not account for all risks including environmental hazards, zoning changes, market downturns, tenant defaults, and regulatory changes.</p>
        <p style="margin-bottom:8px"><strong>Investment Risk.</strong> Real estate investment involves substantial risk including potential total loss. Leverage amplifies both gains and losses.</p>
        <p style="margin-bottom:8px"><strong>Limitation of Liability.</strong> Creators disclaim all liability for damages arising from use of this tool or reliance on its outputs.</p>
        <p><strong>No Fiduciary Relationship.</strong> Use of this tool creates no advisory or professional relationship.</p>
      </div>
    </div>
  </div>

</div><!-- end desktop-right -->
</div><!-- end desktop-layout -->
</div><!-- end content -->

<!-- Email Capture Modal -->
<div class="email-overlay" id="emailOverlay">
  <div class="email-modal">
    <h3>Get your analysis emailed to you</h3>
    <p>Enter your email to receive a copy (optional).</p>
    <form id="emailForm">
      <input type="email" name="email" id="emailInput" placeholder="you@example.com" required>
      <input type="hidden" id="emailAddr">
      <button type="submit" class="email-submit">Send &amp; Download</button>
    </form>
    <button type="button" class="email-skip" id="emailSkip">No thanks, just download</button>
  </div>
</div>

<footer class="footer">
  <div class="footer-inner">
    <div class="footer-col">
      <h4>Quick RE Analyzer</h4>
      <div style="line-height:1.6">Free real estate deal analysis.<br>Compare Buy &amp; Hold, BRRRR, and Flip strategies.</div>
    </div>
    <div class="footer-col">
      <h4>Tools</h4>
      <a href="/#calculator">Deal Calculator</a>
      <a href="/blog/how-to-analyze-brrrr-deal.html">BRRRR Guide</a>
      <a href="/blog/cash-on-cash-return-explained.html">CoC Explained</a>
    </div>
    <div class="footer-col">
      <h4>Resources</h4>
      <a href="/blog/buy-and-hold-vs-brrrr-vs-flip.html">Strategy Comparison</a>
      <a href="/blog/our-story.html">Our Story</a>
      <a href="/about.html">About</a>
    </div>
  </div>
  <div class="footer-copy">&copy; 2026 Quick Real Estate Analyzer. For educational purposes only. Not financial advice.</div>
</footer>

<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<script>
(function(){
var $=function(id){return document.getElementById(id)};
var vl=function(id){return parseFloat($(id).value)||0};
var fmt=function(x){return x==null?"---":"$"+Math.round(x).toLocaleString()};
var fPct=function(x){return x==null?"---":(x*100).toFixed(2)+"%"};
var fX=function(x){return x==null?"---":x.toFixed(2)+"x"};
function pmtCalc(r,n,pv){if(r===0)return -pv/n;var x=Math.pow(1+r,n);return(-pv*r*x)/(x-1)}
function loanBalF(r,n,pv,e){if(r===0)return pv-(pv/n)*e;var x=Math.pow(1+r,n),y=Math.pow(1+r,e);return pv*(x-y)/(x-1)}
function calcIRR(cf){var r=0.1;for(var i=0;i<1000;i++){var npv=0,dnpv=0;for(var t=0;t<cf.length;t++){var d=Math.pow(1+r,t);npv+=cf[t]/d;dnpv-=t*cf[t]/(d*(1+r))}var nr=r-npv/dnpv;if(Math.abs(nr-r)<1e-8)return nr;r=nr;if(!isFinite(r)||r<-1)return null}return null}
function annDS(rRate,termYrs,loan,yr,io,ioYrs){var mr=rRate/12;if(io&&yr<=ioYrs)return loan*mr*12;if(io&&yr>ioYrs){var rt=(termYrs-ioYrs)*12;return-pmtCalc(mr,rt,loan)*12}return-pmtCalc(mr,termYrs*12,loan)*12}
function loanBalY(rRate,termYrs,loan,yr,io,ioYrs){var mr=rRate/12;if(io){if(yr<=ioYrs)return loan;return loanBalF(mr,(termYrs-ioYrs)*12,loan,(yr-ioYrs)*12)}return loanBalF(mr,termYrs*12,loan,yr*12)}

var useHM=false,useIO=false,showPF=false,showSA=false,numUnits=1,rehabMode='total',activeStrat='bh';
var units=[{type:'ltr',rent:1800,nightly:150,occ:70,furnish:0}];
var lastBH=null,lastBR=null,lastFL=null;

// ─── Section Toggles ─────────────────────────────────────────
function setupSec(bid,bodyid,aid,open){
  var b=$(bid),bd=$(bodyid),ar=$(aid),isO=open;
  function t(e){e.preventDefault();isO=!isO;if(isO){bd.classList.add('open');ar.style.transform='rotate(90deg)'}else{bd.classList.remove('open');ar.style.transform='rotate(0deg)'}}
  b.addEventListener('click',t,false);b.addEventListener('touchend',function(e){e.preventDefault();t(e)},false);
}
setupSec('secPropBtn','secProp','arrowProp',true);
setupSec('secDealBtn','secDeal','arrowDeal',true);
setupSec('secFinBtn','secFin','arrowFin',false);
setupSec('secAssBtn','secAss','arrowAss',false);

// ─── Strategy Tabs ───────────────────────────────────────────
var stratBtns=document.querySelectorAll('.strat-tab');
for(var si=0;si<stratBtns.length;si++){
  (function(btn){
    function handler(e){
      e.preventDefault();
      activeStrat=btn.getAttribute('data-strat');
      for(var k=0;k<stratBtns.length;k++)stratBtns[k].classList.remove('active');
      btn.classList.add('active');
      document.querySelectorAll('.strat-panel').forEach(function(p){p.classList.remove('active')});
      $('panel_'+activeStrat).classList.add('active');
      $('pfSection').style.display=activeStrat==='flip'?'none':'block';
      updatePF();
    }
    btn.addEventListener('click',handler,false);
    btn.addEventListener('touchend',function(e){e.preventDefault();handler(e)},false);
  })(stratBtns[si]);
}

// ─── Unit Cards ──────────────────────────────────────────────
function saveUD(){
  var cards=document.querySelectorAll('.unit-card');
  for(var i=0;i<cards.length&&i<units.length;i++){
    var ri=cards[i].querySelector('.u-rent'),ni=cards[i].querySelector('.u-nightly'),oi=cards[i].querySelector('.u-occ'),fi=cards[i].querySelector('.u-furn');
    if(ri)units[i].rent=parseFloat(ri.value)||0;
    if(ni)units[i].nightly=parseFloat(ni.value)||0;
    if(oi)units[i].occ=parseFloat(oi.value)||0;
    if(fi)units[i].furnish=parseFloat(fi.value)||0;
  }
}

function buildCards(){
  saveUD();
  var c=$('unitCards'),html='';
  for(var i=0;i<numUnits;i++){
    if(i>=units.length)units.push({type:'ltr',rent:1800,nightly:150,occ:70,furnish:0});
    var u=units[i],isL=u.type==='ltr';
    html+='<div class="unit-card" data-idx="'+i+'"><div class="unit-hdr"><span>Unit '+(i+1)+'</span>';
    html+='<div class="type-toggle"><button type="button" class="type-opt'+(isL?' active':'')+'" data-t="ltr">LTR</button><button type="button" class="type-opt'+(!isL?' active':'')+'" data-t="str">STR</button></div></div>';
    html+='<div class="unit-fields">';
    if(isL){
      html+='<div class="unit-fields-row"><div class="field"><label>Monthly Rent</label><div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" class="u-rent" value="'+u.rent+'" step="50"></div></div></div>';
    }else{
      html+='<div class="unit-fields-row"><div class="field"><label>Avg Nightly Rate</label><div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" class="u-nightly" value="'+u.nightly+'" step="5"></div></div>';
      html+='<div class="field"><label>Occupancy</label><div class="iw"><input type="number" inputmode="decimal" class="u-occ" value="'+u.occ+'" step="1"><span class="suf">%</span></div></div></div>';
      var mo=Math.round(u.nightly*(u.occ/100)*30.44);
      html+='<div class="str-calc">= $'+mo.toLocaleString()+'/mo estimated revenue</div>';
      html+='<div class="field"><label>Furnishing Cost</label><div class="iw"><span class="pre">$</span><input type="number" inputmode="decimal" class="u-furn" value="'+u.furnish+'" step="500"></div></div>';
    }
    html+='</div></div>';
  }
  c.innerHTML=html;
  $('unitCount').textContent=numUnits;

  // Live STR calc
  c.querySelectorAll('.u-nightly, .u-occ').forEach(function(inp){
    inp.addEventListener('input',function(){
      var card=inp.closest('.unit-card');
      var ni=card.querySelector('.u-nightly'),oi=card.querySelector('.u-occ'),calc=card.querySelector('.str-calc');
      if(ni&&oi&&calc){
        var mo=Math.round((parseFloat(ni.value)||0)*((parseFloat(oi.value)||0)/100)*30.44);
        calc.textContent='= $'+mo.toLocaleString()+'/mo estimated revenue';
      }
    });
  });

  // Type toggles
  c.querySelectorAll('.type-opt').forEach(function(btn){
    function h(e){e.preventDefault();var card=btn.closest('.unit-card');var idx=parseInt(card.getAttribute('data-idx'));saveUD();units[idx].type=btn.getAttribute('data-t');buildCards()}
    btn.addEventListener('click',h,false);btn.addEventListener('touchend',function(e){e.preventDefault();h(e)},false);
  });
}

function addU(e){if(e)e.preventDefault();if(numUnits<20){numUnits++;buildCards()}}
function remU(e){if(e)e.preventDefault();if(numUnits>1){saveUD();numUnits--;units.length=numUnits;buildCards()}}
$('unitPlus').addEventListener('click',addU,false);$('unitPlus').addEventListener('touchend',function(e){e.preventDefault();addU(e)},false);
$('unitMinus').addEventListener('click',remU,false);$('unitMinus').addEventListener('touchend',function(e){e.preventDefault();remU(e)},false);

// ─── Rehab Toggle ────────────────────────────────────────────
var rehabBtns=document.querySelectorAll('.rehab-opt');
rehabBtns.forEach(function(btn){
  function h(e){e.preventDefault();rehabMode=btn.getAttribute('data-mode');rehabBtns.forEach(function(b){b.classList.remove('active')});btn.classList.add('active');$('rehabTotal').style.display=rehabMode==='total'?'block':'none';$('rehabSqft').style.display=rehabMode==='sqft'?'block':'none';updRehab()}
  btn.addEventListener('click',h,false);btn.addEventListener('touchend',function(e){e.preventDefault();h(e)},false);
});
function updRehab(){if(rehabMode==='sqft')$('calcRehab').textContent=fmt(vl('sqft')*vl('costPerSqft'))}
['sqft','costPerSqft'].forEach(function(id){$(id).addEventListener('input',updRehab)});

// ─── Toggles ─────────────────────────────────────────────────
function setupTog(btnId,cb){var btn=$(btnId);btn.addEventListener('click',function(e){e.preventDefault();cb()},false);btn.addEventListener('touchend',function(e){e.preventDefault();cb()},false)}
setupTog('ioToggle',function(){useIO=!useIO;$('ioToggle').classList.toggle('on');$('ioFields').style.display=useIO?'block':'none'});
setupTog('hmToggle',function(){useHM=!useHM;$('hmToggle').classList.toggle('on');$('hmFields').classList.toggle('show')});

var showPF=false,showSA=false;
setupTog('pfToggle',function(){showPF=!showPF;$('pfCard').style.display=showPF?'block':'none';$('pfToggle').textContent=showPF?'Hide 10-Year Pro Forma':'Show 10-Year Pro Forma'});
setupTog('saToggle',function(){showSA=!showSA;$('saCard').style.display=showSA?'block':'none';$('saToggle').textContent=showSA?'Hide Sensitivity Analysis':'Show Sensitivity Analysis'});
setupTog('discBtn',function(){var o=$('discFull').style.display==='block';$('discFull').style.display=o?'none':'block';$('discBtn').textContent=o?'Read Full Disclaimer':'Hide Full Disclaimer'});

// ─── Getters ─────────────────────────────────────────────────
function getRents(){saveUD();var r=[];for(var i=0;i<numUnits;i++){var u=units[i];r.push(u.type==='ltr'?u.rent:Math.round(u.nightly*(u.occ/100)*30.44))}return r}
function getTotalFurnish(){saveUD();var t=0;for(var i=0;i<numUnits;i++)if(units[i].type==='str')t+=units[i].furnish;return t}
function getRehab(){return rehabMode==='sqft'?vl('sqft')*vl('costPerSqft'):vl('rehabBudget')}

// ─── Shared inputs ───────────────────────────────────────────
function getInputs(rentOv,vacOv){
  var rents=rentOv||getRents();var totalR=0;for(var i=0;i<rents.length;i++)totalR+=rents[i];
  return{pp:vl('purchasePrice'),rehab:getRehab(),arv:vl('arv'),rent:totalR,rents:rents,
    ins:vl('monthlyInsurance'),tax:vl('monthlyTax'),closePct:vl('closingCostPct')/100,
    vacRate:vacOv!=null?vacOv/100:vl('vacancyPct')/100,mgmt:vl('mgmtPct')/100,capex:vl('capexPct')/100,
    rGrowth:vl('rentGrowth')/100,appRate:vl('appreciation')/100,sellPct:vl('sellCostPct')/100,
    furnish:getTotalFurnish()};
}

// ─── Buy & Hold Analysis ─────────────────────────────────────
function analyzeBH(rentOv,vacOv){
  var inp=getInputs(rentOv,vacOv);if(inp.pp<=0||inp.arv<=0)return null;
  var downPct=vl('downPct')/100,bhRate=vl('bhRate')/100,bhTerm=vl('bhTermYears');
  var downAmt=inp.pp*downPct;
  var loanAmt=inp.pp-downAmt;
  var buyClose=inp.pp*inp.closePct;
  var totalCashIn=downAmt+buyClose+inp.rehab+inp.furnish;
  var moMort=loanAmt>0?-pmtCalc(bhRate/12,bhTerm*12,loanAmt):0;

  var years=[],irrCF=[-totalCashIn];
  for(var yr=1;yr<=10;yr++){
    var annR=inp.rent*12*Math.pow(1+inp.rGrowth,yr-1);
    var effR=annR*(1-inp.vacRate);
    var opex=effR*inp.mgmt+effR*inp.capex+(inp.ins+inp.tax)*12;
    var noi=effR-opex;var ds=moMort*12;var cf=noi-ds;
    var pv=inp.arv*Math.pow(1+inp.appRate,yr);
    var rl=loanAmt>0?loanBalF(bhRate/12,bhTerm*12,loanAmt,yr*12):0;
    var eq=pv-rl;
    var sp=yr===10?pv-rl-pv*inp.sellPct:0;
    years.push({yr:yr,effRent:effR,opex:opex,noi:noi,debtSvc:ds,cf:cf,propVal:pv,remLoan:rl,equity:eq,saleProceeds:sp});
    irrCF.push(yr<10?cf:cf+sp);
  }
  var coc=totalCashIn>0?years[0].cf/totalCashIn:null;
  var irr=calcIRR(irrCF);
  var totCF=0;for(var i=0;i<10;i++)totCF+=years[i].cf;
  var moic=totalCashIn>0?(totCF+years[9].saleProceeds)/totalCashIn:null;
  return{totalCashIn:totalCashIn,downAmt:downAmt,loanAmt:loanAmt,buyClose:buyClose,moMort:moMort,
    coc:coc,irr:irr,moic:moic,years:years,inp:inp};
}

// ─── BRRRR Analysis ──────────────────────────────────────────
function analyzeBR(rentOv,vacOv){
  var inp=getInputs(rentOv,vacOv);if(inp.pp<=0||inp.arv<=0)return null;
  var rRate=vl('refiRate')/100,ltv=vl('refiLtv')/100,termYrs=vl('refiTermYears');
  var ioYrs=useIO?vl('ioYears'):0;
  var tpc=inp.pp+inp.rehab;
  var initCash=tpc+inp.furnish;var hmInt=0,hmPts=0,hmPay=0;
  if(useHM){var hmr=vl('hmRate')/100,hmp=vl('hmPoints')/100,hltc=vl('hmLtc')/100,hterm=vl('hmTermMonths');
    var hLoan=tpc*hltc;hmPts=hLoan*hmp;hmInt=hLoan*(hmr/12)*hterm;
    initCash=tpc+inp.furnish-hLoan+hmPts+hmInt;hmPay=hLoan;}
  var pClose=inp.pp*inp.closePct;initCash+=pClose;
  var refiLoan=inp.arv*ltv;var refiClose=refiLoan*inp.closePct;
  var cashBack=refiLoan-refiClose-hmPay;
  var totalCashIn=Math.max(initCash-cashBack,0);

  var years=[],irrCF=[-totalCashIn];
  for(var yr=1;yr<=10;yr++){
    var annR=inp.rent*12*Math.pow(1+inp.rGrowth,yr-1);
    var effR=annR*(1-inp.vacRate);
    var opex=effR*inp.mgmt+effR*inp.capex+(inp.ins+inp.tax)*12;
    var noi=effR-opex;
    var ds=annDS(rRate,termYrs,refiLoan,yr,useIO,ioYrs);
    var cf=noi-ds;
    var pv=inp.arv*Math.pow(1+inp.appRate,yr);
    var rl=loanBalY(rRate,termYrs,refiLoan,yr,useIO,ioYrs);
    var eq=pv-rl;var sp=yr===10?pv-rl-pv*inp.sellPct:0;
    years.push({yr:yr,effRent:effR,opex:opex,noi:noi,debtSvc:ds,cf:cf,propVal:pv,remLoan:rl,equity:eq,saleProceeds:sp});
    irrCF.push(yr<10?cf:cf+sp);
  }
  var coc=totalCashIn>0?years[0].cf/totalCashIn:null;
  var unlev=(tpc+inp.furnish+pClose)>0?years[0].noi/(tpc+inp.furnish+pClose):null;
  var irr=calcIRR(irrCF);
  var totCF=0;for(var i=0;i<10;i++)totCF+=years[i].cf;
  var moic=totalCashIn>0?(totCF+years[9].saleProceeds)/totalCashIn:null;
  return{totalCashIn:totalCashIn,tpc:tpc,initCash:initCash,pClose:pClose,refiLoan:refiLoan,refiClose:refiClose,
    cashBack:cashBack,hmInt:hmInt,hmPts:hmPts,hmPay:hmPay,
    coc:coc,unlev:unlev,irr:irr,moic:moic,years:years,inp:inp,rRate:rRate};
}

// ─── Flip Analysis ───────────────────────────────────────────
function analyzeFL(){
  var inp=getInputs();if(inp.pp<=0||inp.arv<=0)return null;
  var holdMo=vl('flipHoldMonths'),holdCostMo=vl('flipHoldCostMo');
  var tpc=inp.pp+inp.rehab;
  var buyClose=inp.pp*inp.closePct;
  var holdCosts=(inp.ins+inp.tax+holdCostMo)*holdMo;
  var hmInt=0,hmPts=0,hmPay=0,hmLoan=0;
  if(useHM){var hmr=vl('hmRate')/100,hmp=vl('hmPoints')/100,hltc=vl('hmLtc')/100;
    hmLoan=tpc*hltc;hmPts=hmLoan*hmp;hmInt=hmLoan*(hmr/12)*holdMo;hmPay=hmLoan;}
  var totalCost=tpc+buyClose+holdCosts+hmPts+hmInt;
  var cashInvested=useHM?tpc-hmLoan+buyClose+holdCosts+hmPts+hmInt:totalCost;
  var sellCosts=inp.arv*inp.sellPct;
  var netProceeds=inp.arv-sellCosts-hmPay;
  var profit=netProceeds-cashInvested;
  var roi=cashInvested>0?profit/cashInvested:null;
  var annRoi=roi!=null&&holdMo>0?Math.pow(1+roi,12/holdMo)-1:null;
  return{tpc:tpc,buyClose:buyClose,holdCosts:holdCosts,hmInt:hmInt,hmPts:hmPts,hmPay:hmPay,hmLoan:hmLoan,
    totalCost:totalCost,cashInvested:cashInvested,sellCosts:sellCosts,netProceeds:netProceeds,
    profit:profit,roi:roi,annRoi:annRoi,holdMo:holdMo,inp:inp};
}

// ─── Render helpers ──────────────────────────────────────────
function setMV(id,val,threshold){var el=$(id);el.textContent=fPct(val);el.className='mv '+(val>threshold?'grn':'red')}
function unitRentsHtml(rents){var h='';if(numUnits>1)for(var i=0;i<rents.length;i++){var t=units[i].type==='str'?' (STR)':' (LTR)';h+='<div class="row" style="color:#B5A99A"><span>Unit '+(i+1)+t+'</span><span class="v">'+fmt(rents[i])+'/mo</span></div>'}return h}
function fillCF(pre,inp,moMort){
  $(pre+'_unit_rents').innerHTML=unitRentsHtml(inp.rents);
  $(pre+'_gross').textContent=fmt(inp.rent);
  $(pre+'_vac').textContent=fmt(inp.rent*inp.vacRate);
  $(pre+'_ins').textContent=fmt(inp.ins);
  $(pre+'_tax').textContent=fmt(inp.tax);
  var eff=inp.rent*(1-inp.vacRate);
  $(pre+'_mgmt').textContent=fmt(eff*inp.mgmt);
  $(pre+'_capex').textContent=fmt(eff*inp.capex);
  $(pre+'_mort').textContent=fmt(moMort);
}

// ─── Pro Forma ───────────────────────────────────────────────
function updatePF(){
  var data=activeStrat==='bh'?lastBH:lastBR;
  if(!data)return;
  var html='';
  for(var i=0;i<data.years.length;i++){var y=data.years[i];
    html+='<tr><td class="yr">'+y.yr+'</td><td>'+fmt(y.effRent)+'</td><td>'+fmt(y.opex)+'</td><td style="font-weight:600">'+fmt(y.noi)+'</td><td>'+fmt(y.debtSvc)+'</td><td style="font-weight:700" class="'+(y.cf>=0?'grn':'red')+'">'+fmt(y.cf)+'</td><td>'+fmt(y.propVal)+'</td><td>'+fmt(y.remLoan)+'</td><td style="font-weight:600" class="blu">'+fmt(y.equity)+'</td></tr>';}
  $('pfBody').innerHTML=html;
  $('pfTitle').textContent='10-Year Pro Forma — '+(activeStrat==='bh'?'Buy & Hold':'BRRRR');
  $('pfNote').textContent='Year 10 sale at '+vl('appreciation')+'% annual appreciation, '+vl('sellCostPct')+'% selling costs';
}

// ─── Sensitivity ─────────────────────────────────────────────
function buildSens(){
  var baseRents=getRents(),baseVac=vl('vacancyPct');
  var rs=[-20,-10,0,10,20],vs=[-4,-2,0,2,4];
  var fn=activeStrat==='bh'?analyzeBH:analyzeBR;
  $('saCocTitle').textContent='Sensitivity: CoC Return ('+(activeStrat==='bh'?'Buy & Hold':'BRRRR')+')';
  $('saIrrTitle').textContent='Sensitivity: 10-Year IRR ('+(activeStrat==='bh'?'Buy & Hold':'BRRRR')+')';

  function build(tid,met){
    var h='<tr><th></th>';
    for(var c=0;c<rs.length;c++)h+='<th>'+(rs[c]===0?'Base':(rs[c]>0?'+':'')+rs[c]+'%')+'</th>';
    h+='</tr>';
    for(var r=0;r<vs.length;r++){
      var vv=Math.max(0,baseVac+vs[r]);
      h+='<tr><td>'+(vs[r]===0?'Base':vv.toFixed(0)+'%')+'</td>';
      for(var c=0;c<rs.length;c++){
        var adj=baseRents.map(function(x){return Math.round(x*(1+rs[c]/100))});
        var res=fn(adj,vv);
        var val=res?res[met]:null;
        var isB=rs[c]===0&&vs[r]===0;
        var cls=isB?'base':'';
        if(val!=null)cls+=' '+(val>0?'grn':'red');
        h+='<td class="'+cls+'">'+fPct(val)+'</td>';
      }
      h+='</tr>';
    }
    $(tid).innerHTML=h;
  }
  build('saCocTbl','coc');
  build('saIrrTbl','irr');
}

// ─── State Average Tax & Insurance Rates ────────────────────
// Tax: effective property tax rate (% of value). Source: US Census / Tax Foundation averages.
// Ins: avg annual homeowners insurance per $100k of value.
var STATE_DATA={
AL:{tax:0.41,ins:430},AK:{tax:1.19,ins:500},AZ:{tax:0.63,ins:420},AR:{tax:0.62,ins:520},
CA:{tax:0.74,ins:380},CO:{tax:0.51,ins:530},CT:{tax:2.14,ins:420},DE:{tax:0.57,ins:340},
DC:{tax:0.56,ins:390},FL:{tax:0.89,ins:680},GA:{tax:0.92,ins:450},HI:{tax:0.28,ins:300},
ID:{tax:0.69,ins:370},IL:{tax:2.27,ins:430},IN:{tax:0.85,ins:380},IA:{tax:1.57,ins:390},
KS:{tax:1.41,ins:530},KY:{tax:0.86,ins:440},LA:{tax:0.55,ins:620},ME:{tax:1.36,ins:370},
MD:{tax:1.09,ins:400},MA:{tax:1.23,ins:440},MI:{tax:1.54,ins:400},MN:{tax:1.12,ins:460},
MS:{tax:0.81,ins:530},MO:{tax:0.97,ins:480},MT:{tax:0.84,ins:420},NE:{tax:1.73,ins:480},
NV:{tax:0.60,ins:370},NH:{tax:2.18,ins:380},NJ:{tax:2.49,ins:430},NM:{tax:0.80,ins:400},
NY:{tax:1.72,ins:430},NC:{tax:0.84,ins:410},ND:{tax:0.98,ins:440},OH:{tax:1.56,ins:370},
OK:{tax:0.90,ins:590},OR:{tax:0.97,ins:350},PA:{tax:1.58,ins:380},RI:{tax:1.63,ins:440},
SC:{tax:0.57,ins:450},SD:{tax:1.31,ins:450},TN:{tax:0.71,ins:440},TX:{tax:1.80,ins:580},
UT:{tax:0.63,ins:360},VT:{tax:1.90,ins:380},VA:{tax:0.82,ins:370},WA:{tax:0.98,ins:380},
WV:{tax:0.58,ins:380},WI:{tax:1.85,ins:360},WY:{tax:0.61,ins:380}
};
function estimateTaxIns(e){
  if(e)e.preventDefault();
  var state=$('addrState').value.trim().toUpperCase();
  var pp=parseFloat($('purchasePrice').value)||0;
  if(!state||state.length!==2){$('lookupStatus').innerHTML='<div class="lookup-err">Enter a 2-letter state code first.</div>';return}
  if(!STATE_DATA[state]){$('lookupStatus').innerHTML='<div class="lookup-err">State "'+state+'" not recognized. Use a 2-letter code (e.g. TX, CA, FL).</div>';return}
  if(pp<=0){$('lookupStatus').innerHTML='<div class="lookup-err">Enter a purchase price in Deal Inputs first.</div>';return}
  var d=STATE_DATA[state];
  var moTax=Math.round((pp*d.tax/100)/12);
  var moIns=Math.round((pp/100000*d.ins)/12);
  $('monthlyTax').value=moTax;$('monthlyTax').dispatchEvent(new Event('input'));
  $('monthlyInsurance').value=moIns;$('monthlyInsurance').dispatchEvent(new Event('input'));
  $('lookupStatus').innerHTML='<div class="lookup-result">'+state+' avg: Tax ~$'+moTax+'/mo ('+d.tax+'% rate) &middot; Insurance ~$'+moIns+'/mo &middot; Based on $'+pp.toLocaleString()+' value</div>';
}
$('lookupBtn').addEventListener('click',estimateTaxIns,false);
$('lookupBtn').addEventListener('touchend',function(e){e.preventDefault();estimateTaxIns(e)},false);

// ─── Address Validation ─────────────────────────────────────
function getFullAddress(){
  var s=$('addrStreet').value.trim(),u=$('addrUnit').value.trim(),c=$('addrCity').value.trim(),st=$('addrState').value.trim().toUpperCase(),z=$('addrZip').value.trim();
  var line=s;if(u)line+=' '+u;if(c)line+=', '+c;if(st)line+=', '+st;if(z)line+=' '+z;return line;
}
function validateAddr(){
  var ids=['addrStreet','addrCity','addrState','addrZip'],ok=true;
  for(var i=0;i<ids.length;i++){var el=$(ids[i]);if(!el.value.trim()){el.classList.add('addr-err');ok=false}else{el.classList.remove('addr-err')}}
  $('addrErr').classList.toggle('show',!ok);
  if(!ok){$('addrStreet').scrollIntoView({behavior:'smooth',block:'center'})}
  return ok;
}
['addrStreet','addrCity','addrState','addrZip'].forEach(function(id){$(id).addEventListener('input',function(){$(id).classList.remove('addr-err');$('addrErr').classList.remove('show')})});

// ─── Main Calculate ──────────────────────────────────────────
function calculate(e){
  if(e)e.preventDefault();
  if(!validateAddr())return;
  lastBH=analyzeBH();lastBR=analyzeBR();lastFL=analyzeFL();
  if(!lastBH&&!lastBR)return;
  $('results').classList.add('show');

  // Buy & Hold
  if(lastBH){
    var b=lastBH;
    setMV('bh_coc',b.coc,0);setMV('bh_irr',b.irr,0);
    $('bh_moic').textContent=fX(b.moic);$('bh_moic').className='mv '+(b.moic>1?'grn':'red');
    var mcf=b.years[0].cf/12;$('bh_mcf').textContent=fmt(mcf);$('bh_mcf').className='mv '+(mcf>=0?'grn':'red');
    $('bh_pp').textContent=fmt(b.inp.pp);$('bh_rehab').textContent=fmt(b.inp.rehab);
    $('bh_furn').textContent=fmt(b.inp.furnish);$('bh_close').textContent=fmt(b.buyClose);
    $('bh_down').textContent=fmt(b.downAmt);$('bh_loan').textContent=fmt(b.loanAmt);
    $('bh_cashin').textContent=fmt(b.totalCashIn);
    fillCF('bh',b.inp,b.moMort);
    var ncf=$('bh_ncf');ncf.textContent=fmt(mcf)+'/mo';ncf.className='v '+(mcf>=0?'grn':'red');
  }

  // BRRRR
  if(lastBR){
    var r=lastBR;
    setMV('br_coc',r.coc,0);
    $('br_unlev').textContent=fPct(r.unlev);$('br_unlev').className='mv '+(r.unlev>0?'blu':'red');
    setMV('br_irr',r.irr,0);
    $('br_moic').textContent=fX(r.moic);$('br_moic').className='mv '+(r.moic>1?'grn':'red');
    $('br_tpc').textContent=fmt(r.tpc);$('br_furn').textContent=fmt(r.inp.furnish);
    if(useHM&&r.hmPts>0){$('br_hmrow').style.display='flex';$('br_hmcost').textContent=fmt(r.hmPts+r.hmInt)}else{$('br_hmrow').style.display='none'}
    $('br_pclose').textContent=fmt(r.pClose);$('br_cashout').textContent=fmt(r.initCash);
    $('br_refiloan').textContent=fmt(r.refiLoan);$('br_reficlose').textContent=fmt(r.refiClose);
    if(useHM){$('br_hmpayrow').style.display='flex';$('br_hmpay').textContent=fmt(r.hmPay)}else{$('br_hmpayrow').style.display='none'}
    $('br_cashback').textContent=fmt(r.cashBack);$('br_cashin').textContent=fmt(r.totalCashIn);
    var moDS=r.years[0].debtSvc/12;
    fillCF('br',r.inp,moDS);
    if(useIO){$('br_iolabel').style.display='flex';$('br_iolabel').querySelector('span').textContent='(I/O for '+vl('ioYears')+' yrs)'}else{$('br_iolabel').style.display='none'}
    var bncf=r.years[0].cf/12;var bel=$('br_ncf');bel.textContent=fmt(bncf)+'/mo';bel.className='v '+(bncf>=0?'grn':'red');
  }

  // Flip
  if(lastFL){
    var f=lastFL;
    var pEl=$('fl_profit');pEl.textContent=fmt(f.profit);pEl.className='flip-profit '+(f.profit>=0?'grn':'red');
    $('fl_roi').textContent=fPct(f.roi);$('fl_roi').className=(f.roi>0?'grn':'red');
    $('fl_aroi').textContent=fPct(f.annRoi);$('fl_aroi').className=(f.annRoi>0?'grn':'red');
    $('fl_pp').textContent=fmt(f.inp.pp);$('fl_rehab').textContent=fmt(f.inp.rehab);
    $('fl_bclose').textContent=fmt(f.buyClose);
    if(useHM){$('fl_hmrow').style.display='flex';$('fl_hmcost').textContent=fmt(f.hmPts+f.hmInt);$('fl_hmpayrow').style.display='flex';$('fl_hmpay').textContent=fmt(f.hmPay)}
    else{$('fl_hmrow').style.display='none';$('fl_hmpayrow').style.display='none'}
    $('fl_hold').textContent=fmt(f.holdCosts);$('fl_totalcost').textContent=fmt(f.totalCost);
    $('fl_arv').textContent=fmt(f.inp.arv);$('fl_sellcost').textContent=fmt(f.sellCosts);
    $('fl_proceeds').textContent=fmt(f.netProceeds);$('fl_profitline').textContent=fmt(f.profit);
    $('fl_cashin').textContent=fmt(f.cashInvested);$('fl_time').textContent=f.holdMo;
  }

  updatePF();buildSens();
  $('results').scrollIntoView({behavior:'smooth',block:'start'});
}

$('calcBtn').addEventListener('click',calculate,false);
$('calcBtn').addEventListener('touchend',function(e){e.preventDefault();calculate(e)},false);

// ─── Shared export helpers ───────────────────────────────────
function getExportFilename(ext){
  var fn='RE_Analysis';
  var streetName=$('addrStreet').value.trim();
  if(streetName)fn=streetName.replace(/[^a-zA-Z0-9]/g,'_').replace(/_+/g,'_').substring(0,40);
  return fn+'_'+new Date().toISOString().slice(0,10)+'.'+ext;
}

// ─── Excel Download (Enhanced) ──────────────────────────────
function downloadExcel(e){
  if(e)e.preventDefault();
  if(!lastBH&&!lastBR){alert('Please calculate first.');return}
  var wb=XLSX.utils.book_new();
  var addr=getFullAddress();
  saveUD();var rents=getRents();

  var s=[];
  s.push(['Quick Real Estate Analysis','','','']);
  s.push(['Property',addr||'(No address entered)','','Date',new Date().toLocaleDateString()]);
  s.push([]);

  s.push(['UNIT DETAILS','','','']);
  for(var i=0;i<numUnits;i++){var u=units[i];
    if(u.type==='ltr')s.push(['Unit '+(i+1)+' (LTR)','Monthly Rent','',rents[i]]);
    else s.push(['Unit '+(i+1)+' (STR)','Nightly: $'+u.nightly,'Occ: '+u.occ+'%',rents[i]]);
  }
  s.push(['Total Monthly Rent','','',rents.reduce(function(a,b){return a+b},0)]);
  s.push([]);

  s.push(['DEAL INPUTS','','','']);
  s.push(['Purchase Price','',vl('purchasePrice')]);
  s.push(['Rehab Budget','',getRehab()]);
  s.push(['After Repair Value (ARV)','',vl('arv')]);
  s.push(['Monthly Insurance','',vl('monthlyInsurance')]);
  s.push(['Monthly Tax','',vl('monthlyTax')]);
  s.push(['Selling Costs','',vl('sellCostPct')/100]);
  s.push([]);

  s.push(['STRATEGY COMPARISON','Buy & Hold','BRRRR','Flip']);
  s.push(['Cash Invested',lastBH?lastBH.totalCashIn:null,lastBR?lastBR.totalCashIn:null,lastFL?lastFL.cashInvested:null]);
  s.push(['Year 1 CoC Return',lastBH?lastBH.coc:null,lastBR?lastBR.coc:null,null]);
  s.push(['10-Year IRR',lastBH?lastBH.irr:null,lastBR?lastBR.irr:null,null]);
  s.push(['MOIC',lastBH?lastBH.moic:null,lastBR?lastBR.moic:null,null]);
  s.push(['Flip ROI',null,null,lastFL?lastFL.roi:null]);
  s.push(['Flip Annualized ROI',null,null,lastFL?lastFL.annRoi:null]);
  s.push(['Flip Profit',null,null,lastFL?lastFL.profit:null]);

  var ws1=XLSX.utils.aoa_to_sheet(s);
  ws1['!cols']=[{wch:24},{wch:18},{wch:18},{wch:18},{wch:16}];
  ws1['!merges']=[{s:{r:0,c:0},e:{r:0,c:3}}];

  var dealStart=3+numUnits+4;
  for(var r=dealStart;r<dealStart+5;r++){
    var cl=XLSX.utils.encode_cell({r:r,c:2});
    if(ws1[cl]&&typeof ws1[cl].v==='number')ws1[cl].z='$#,##0';
  }
  var scCell=XLSX.utils.encode_cell({r:dealStart+5,c:2});
  if(ws1[scCell])ws1[scCell].z='0.0%';

  var compStart=dealStart+8;
  for(var c=1;c<=3;c++){
    var cashCell=XLSX.utils.encode_cell({r:compStart,c:c});
    if(ws1[cashCell]&&typeof ws1[cashCell].v==='number')ws1[cashCell].z='$#,##0';
    var profCell=XLSX.utils.encode_cell({r:compStart+6,c:c});
    if(ws1[profCell]&&typeof ws1[profCell].v==='number')ws1[profCell].z='$#,##0';
  }
  for(var rr=compStart+1;rr<=compStart+5;rr++){
    for(var cc=1;cc<=3;cc++){
      var pcell=XLSX.utils.encode_cell({r:rr,c:cc});
      if(ws1[pcell]&&typeof ws1[pcell].v==='number')ws1[pcell].z='0.00%';
    }
  }
  for(var mc=1;mc<=3;mc++){
    var moicCell=XLSX.utils.encode_cell({r:compStart+3,c:mc});
    if(ws1[moicCell]&&typeof ws1[moicCell].v==='number')ws1[moicCell].z='0.00"x"';
  }
  for(var ur=3;ur<3+numUnits+1;ur++){
    var rc=XLSX.utils.encode_cell({r:ur,c:3});
    if(ws1[rc]&&typeof ws1[rc].v==='number')ws1[rc].z='$#,##0';
  }
  XLSX.utils.book_append_sheet(wb,ws1,'Summary');

  function addPF(name,data){
    if(!data)return;
    var pf=[];
    pf.push(['10-Year Pro Forma: '+name]);
    if(addr)pf.push([addr]);else pf.push([]);
    pf.push([]);
    pf.push(['Year','Eff. Gross Rent','Operating Exp.','NOI','Debt Service','Cash Flow','Property Value','Loan Balance','Equity']);
    data.years.forEach(function(y){
      pf.push([y.yr,y.effRent,y.opex,y.noi,y.debtSvc,y.cf,y.propVal,y.remLoan,y.equity]);
    });
    pf.push([]);
    pf.push(['Year 10 Sale Proceeds','',data.years[9].saleProceeds]);
    pf.push(['Total Cash Invested','',data.totalCashIn]);
    var ws=XLSX.utils.aoa_to_sheet(pf);
    ws['!cols']=[{wch:8},{wch:16},{wch:16},{wch:14},{wch:14},{wch:14},{wch:16},{wch:16},{wch:14}];
    ws['!merges']=[{s:{r:0,c:0},e:{r:0,c:8}},{s:{r:1,c:0},e:{r:1,c:8}}];
    for(var r=4;r<=13;r++){
      for(var c=1;c<=8;c++){
        var cl=XLSX.utils.encode_cell({r:r,c:c});
        if(ws[cl]&&typeof ws[cl].v==='number')ws[cl].z='$#,##0';
      }
    }
    for(var sr=15;sr<=16;sr++){
      var sc=XLSX.utils.encode_cell({r:sr,c:2});
      if(ws[sc]&&typeof ws[sc].v==='number')ws[sc].z='$#,##0';
    }
    XLSX.utils.book_append_sheet(wb,ws,name+' Pro Forma');
  }
  addPF('Buy & Hold',lastBH);addPF('BRRRR',lastBR);

  if(lastFL){
    var fl=[];
    fl.push(['Flip Analysis']);
    if(addr)fl.push([addr]);else fl.push([]);
    fl.push([]);
    fl.push(['COSTS','']);
    fl.push(['Purchase Price',lastFL.inp.pp]);
    fl.push(['Rehab',lastFL.inp.rehab]);
    fl.push(['Closing Costs',lastFL.buyClose]);
    fl.push(['Holding Costs',lastFL.holdCosts]);
    if(useHM)fl.push(['Hard Money Costs',lastFL.hmPts+lastFL.hmInt]);
    fl.push(['Total Cost',lastFL.totalCost]);
    fl.push([]);
    fl.push(['PROCEEDS','']);
    fl.push(['Sale Price (ARV)',lastFL.inp.arv]);
    fl.push(['Selling Costs',lastFL.sellCosts]);
    if(useHM)fl.push(['HM Payoff',lastFL.hmPay]);
    fl.push(['Net Proceeds',lastFL.netProceeds]);
    fl.push([]);
    fl.push(['RETURNS','']);
    fl.push(['Profit',lastFL.profit]);
    fl.push(['ROI',lastFL.roi]);
    fl.push(['Annualized ROI',lastFL.annRoi]);
    fl.push(['Hold Period (months)',lastFL.holdMo]);
    fl.push(['Cash Invested',lastFL.cashInvested]);

    var wsf=XLSX.utils.aoa_to_sheet(fl);
    wsf['!cols']=[{wch:24},{wch:18}];
    wsf['!merges']=[{s:{r:0,c:0},e:{r:0,c:1}}];
    var flipRows=wsf['!ref']?XLSX.utils.decode_range(wsf['!ref']).e.r+1:20;
    for(var fr=3;fr<flipRows;fr++){
      var fc=XLSX.utils.encode_cell({r:fr,c:1});
      if(wsf[fc]&&typeof wsf[fc].v==='number'){
        if(Math.abs(wsf[fc].v)<2)wsf[fc].z='0.00%';
        else wsf[fc].z='$#,##0';
      }
    }
    XLSX.utils.book_append_sheet(wb,wsf,'Flip');
  }
  XLSX.writeFile(wb,getExportFilename('xlsx'));
}

// ─── PDF Download ────────────────────────────────────────────
function downloadPDF(e){
  if(e)e.preventDefault();
  if(!lastBH&&!lastBR){alert('Please calculate first.');return}
  var addr=getFullAddress();
  saveUD();var rents=getRents();
  var totalRent=rents.reduce(function(a,b){return a+b},0);

  var doc=new jspdf.jsPDF({orientation:'portrait',unit:'pt',format:'letter'});
  var W=doc.internal.pageSize.getWidth();
  var mg=50;var cw=W-mg*2;
  var y=50;

  doc.setFillColor(44,52,55);
  doc.rect(0,0,W,90,'F');
  doc.setFont('helvetica','bold');doc.setFontSize(22);doc.setTextColor(242,237,227);
  doc.text(addr||'Real Estate Deal Analysis',mg,42);
  doc.setFont('helvetica','normal');doc.setFontSize(10);doc.setTextColor(181,169,154);
  doc.text('Quick Real Estate Analyzer  |  quickreanalyzer.com  |  '+new Date().toLocaleDateString(),mg,65);
  y=110;

  doc.setFont('helvetica','bold');doc.setFontSize(13);doc.setTextColor(44,52,55);
  doc.text('Deal Overview',mg,y);y+=6;
  doc.setDrawColor(92,122,97);doc.setLineWidth(1.5);doc.line(mg,y,mg+100,y);y+=16;

  var dealData=[
    ['Purchase Price',fmt(vl('purchasePrice')),'After Repair Value',fmt(vl('arv'))],
    ['Rehab Budget',fmt(getRehab()),'Monthly Rent',fmt(totalRent)],
    ['Monthly Tax',fmt(vl('monthlyTax')),'Monthly Insurance',fmt(vl('monthlyInsurance'))],
    ['Units',''+numUnits,'Selling Costs',vl('sellCostPct')+'%']
  ];
  doc.autoTable({startY:y,margin:{left:mg,right:mg},theme:'plain',
    styles:{fontSize:10,cellPadding:{top:5,bottom:5,left:6,right:6},textColor:[44,52,55],font:'helvetica'},
    columnStyles:{0:{fontStyle:'bold',cellWidth:120,textColor:[84,96,112]},1:{cellWidth:cw/2-120},
      2:{fontStyle:'bold',cellWidth:120,textColor:[84,96,112]},3:{cellWidth:cw/2-120}},
    body:dealData
  });
  y=doc.lastAutoTable.finalY+24;

  doc.setFont('helvetica','bold');doc.setFontSize(13);doc.setTextColor(44,52,55);
  doc.text('Strategy Comparison',mg,y);y+=6;
  doc.setDrawColor(92,122,97);doc.setLineWidth(1.5);doc.line(mg,y,mg+130,y);y+=16;

  var compHead=[['','Buy & Hold','BRRRR','Flip']];
  var compBody=[
    ['Cash Invested',lastBH?fmt(lastBH.totalCashIn):'—',lastBR?fmt(lastBR.totalCashIn):'—',lastFL?fmt(lastFL.cashInvested):'—'],
    ['Year 1 Cash-on-Cash',lastBH?fPct(lastBH.coc):'—',lastBR?fPct(lastBR.coc):'—','—'],
    ['10-Year IRR',lastBH?fPct(lastBH.irr):'—',lastBR?fPct(lastBR.irr):'—','—'],
    ['MOIC',lastBH?fX(lastBH.moic):'—',lastBR?fX(lastBR.moic):'—','—'],
    ['ROI','—','—',lastFL?fPct(lastFL.roi):'—'],
    ['Annualized ROI','—','—',lastFL?fPct(lastFL.annRoi):'—'],
    ['Profit','—','—',lastFL?fmt(lastFL.profit):'—']
  ];
  doc.autoTable({startY:y,margin:{left:mg,right:mg},theme:'grid',
    headStyles:{fillColor:[44,52,55],textColor:[242,237,227],fontStyle:'bold',fontSize:10,halign:'center'},
    styles:{fontSize:10,cellPadding:6,textColor:[44,52,55],lineColor:[228,227,216],lineWidth:0.5,font:'helvetica'},
    columnStyles:{0:{fontStyle:'bold',cellWidth:140,textColor:[84,96,112]},1:{halign:'center'},2:{halign:'center'},3:{halign:'center'}},
    head:compHead,body:compBody,
    didParseCell:function(data){
      if(data.section==='body'&&data.column.index>0){
        var v=data.cell.raw;
        if(v&&v!=='—'&&v.indexOf('-')===-1&&(v.indexOf('%')>-1||v.indexOf('$')>-1||v.indexOf('x')>-1)){
          data.cell.styles.textColor=[92,122,97];
        }
        if(v&&v.indexOf('-')===0){data.cell.styles.textColor=[164,87,75]}
      }
    }
  });
  y=doc.lastAutoTable.finalY+24;

  function addPFtoPDF(name,data){
    if(!data)return;
    if(y>550){doc.addPage();y=50}
    doc.setFont('helvetica','bold');doc.setFontSize(13);doc.setTextColor(44,52,55);
    doc.text('10-Year Pro Forma: '+name,mg,y);y+=6;
    doc.setDrawColor(92,122,97);doc.setLineWidth(1.5);doc.line(mg,y,mg+160,y);y+=16;

    var pfHead=[['Yr','Eff. Rent','OpEx','NOI','Debt Svc','Cash Flow','Prop Value','Loan Bal','Equity']];
    var pfBody=data.years.map(function(yr){return[
      yr.yr,fmt(yr.effRent),fmt(yr.opex),fmt(yr.noi),fmt(yr.debtSvc),fmt(yr.cf),fmt(yr.propVal),fmt(yr.remLoan),fmt(yr.equity)
    ]});
    pfBody.push(['Sale','','',fmt(data.years[9].saleProceeds),'','','','','']);

    doc.autoTable({startY:y,margin:{left:mg,right:mg},theme:'striped',
      headStyles:{fillColor:[44,52,55],textColor:[242,237,227],fontStyle:'bold',fontSize:8,halign:'center'},
      styles:{fontSize:8,cellPadding:4,textColor:[44,52,55],font:'helvetica'},
      alternateRowStyles:{fillColor:[248,245,238]},
      columnStyles:{0:{halign:'center',cellWidth:28},1:{halign:'right'},2:{halign:'right'},3:{halign:'right'},
        4:{halign:'right'},5:{halign:'right'},6:{halign:'right'},7:{halign:'right'},8:{halign:'right'}},
      head:pfHead,body:pfBody,
      didParseCell:function(data){
        if(data.section==='body'&&data.column.index===5){
          var v=data.cell.raw;
          if(v&&v.indexOf('-')>-1&&v.indexOf('$')>-1)data.cell.styles.textColor=[164,87,75];
          else if(v&&v!=='---')data.cell.styles.textColor=[92,122,97];
        }
      }
    });
    y=doc.lastAutoTable.finalY+24;
  }
  addPFtoPDF('Buy & Hold',lastBH);
  addPFtoPDF('BRRRR',lastBR);

  if(lastFL){
    if(y>550){doc.addPage();y=50}
    doc.setFont('helvetica','bold');doc.setFontSize(13);doc.setTextColor(44,52,55);
    doc.text('Flip Analysis',mg,y);y+=6;
    doc.setDrawColor(92,122,97);doc.setLineWidth(1.5);doc.line(mg,y,mg+90,y);y+=16;

    var flipRows=[
      ['Purchase Price',fmt(lastFL.inp.pp)],['Rehab',fmt(lastFL.inp.rehab)],
      ['Closing Costs',fmt(lastFL.buyClose)],['Holding Costs',fmt(lastFL.holdCosts)]
    ];
    if(useHM)flipRows.push(['Hard Money Costs',fmt(lastFL.hmPts+lastFL.hmInt)]);
    flipRows.push([{content:'Total Cost',styles:{fontStyle:'bold'}},{content:fmt(lastFL.totalCost),styles:{fontStyle:'bold'}}]);
    flipRows.push(['','']);
    flipRows.push(['Sale Price (ARV)',fmt(lastFL.inp.arv)]);
    flipRows.push(['Selling Costs',fmt(lastFL.sellCosts)]);
    if(useHM)flipRows.push(['HM Payoff',fmt(lastFL.hmPay)]);
    flipRows.push([{content:'Net Proceeds',styles:{fontStyle:'bold'}},{content:fmt(lastFL.netProceeds),styles:{fontStyle:'bold'}}]);
    flipRows.push(['','']);
    flipRows.push([{content:'Profit',styles:{fontStyle:'bold',textColor:[92,122,97]}},{content:fmt(lastFL.profit),styles:{fontStyle:'bold',textColor:lastFL.profit>=0?[92,122,97]:[164,87,75]}}]);
    flipRows.push(['ROI',fPct(lastFL.roi)]);
    flipRows.push(['Annualized ROI',fPct(lastFL.annRoi)]);
    flipRows.push(['Hold Period',lastFL.holdMo+' months']);
    flipRows.push(['Cash Invested',fmt(lastFL.cashInvested)]);

    doc.autoTable({startY:y,margin:{left:mg,right:mg},theme:'plain',
      styles:{fontSize:10,cellPadding:{top:5,bottom:5,left:8,right:8},textColor:[44,52,55],font:'helvetica'},
      columnStyles:{0:{cellWidth:180,fontStyle:'bold',textColor:[84,96,112]},1:{halign:'right'}},
      body:flipRows,tableWidth:340
    });
    y=doc.lastAutoTable.finalY+24;
  }

  var pages=doc.internal.getNumberOfPages();
  for(var p=1;p<=pages;p++){
    doc.setPage(p);
    doc.setFontSize(8);doc.setTextColor(181,169,154);doc.setFont('helvetica','normal');
    doc.text('quickreanalyzer.com — For informational purposes only. Not financial advice.',mg,doc.internal.pageSize.getHeight()-30);
    doc.text('Page '+p+' of '+pages,W-mg-50,doc.internal.pageSize.getHeight()-30);
  }

  doc.save(getExportFilename('pdf'));
}
$('pdfBtn').addEventListener('click',function(e){e.preventDefault();downloadPDF(e)},false);
$('pdfBtn').addEventListener('touchend',function(e){e.preventDefault();downloadPDF(e)},false);

// ─── Email Capture on Download ──────────────────────────────
var emailShown=false;
function handleDownload(e){
  if(e)e.preventDefault();
  if(!lastBH&&!lastBR){alert('Please calculate first.');return}
  if(!emailShown){
    emailShown=true;
    $('emailAddr').value=getFullAddress();
    $('emailOverlay').classList.add('show');
    return;
  }
  downloadExcel();
}
$('dlBtn').addEventListener('click',handleDownload,false);
$('dlBtn').addEventListener('touchend',function(e){e.preventDefault();handleDownload(e)},false);
$('emailSkip').addEventListener('click',function(e){e.preventDefault();$('emailOverlay').classList.remove('show');downloadExcel()},false);
$('emailForm').addEventListener('submit',function(e){
  e.preventDefault();
  var email=$('emailInput').value;
  if(email){
    var gfURL='https://docs.google.com/forms/d/e/1FAIpQLSeLSNqOWiAUUz7X6xBOHT2Du6atNqP_sk2miUTciHHFywgYmg/formResponse';
    var fd=new FormData();
    fd.append('entry.1988375100',email);
    fetch(gfURL,{method:'POST',body:fd,mode:'no-cors'}).catch(function(){});
  }
  $('emailOverlay').classList.remove('show');
  downloadExcel();
});

// ─── Share Analysis ─────────────────────────────────────────
function shareAnalysis(e){
  if(e)e.preventDefault();
  saveUD();
  var params=new URLSearchParams();
  var fields={pp:'purchasePrice',rh:'rehabBudget',arv:'arv',ins:'monthlyInsurance',tx:'monthlyTax',
    sc:'sellCostPct',dp:'downPct',br:'bhRate',bt:'bhTermYears',rr:'refiRate',rl:'refiLtv',
    rt:'refiTermYears',iy:'ioYears',hr:'hmRate',hp:'hmPoints',hl:'hmLtc',ht:'hmTermMonths',
    fh:'flipHoldMonths',fc:'flipHoldCostMo',cc:'closingCostPct',vp:'vacancyPct',mp:'mgmtPct',
    cp:'capexPct',rg:'rentGrowth',ap:'appreciation',sf:'sqft',cs:'costPerSqft'};
  for(var k in fields)params.set(k,$(fields[k]).value);
  params.set('st',$('addrStreet').value);params.set('un',$('addrUnit').value);
  params.set('ci',$('addrCity').value);params.set('sa',$('addrState').value);params.set('zp',$('addrZip').value);
  if(useIO)params.set('io','1');if(useHM)params.set('hm','1');
  params.set('nu',numUnits);
  for(var i=0;i<numUnits;i++){var u=units[i];params.set('u'+i,u.type+','+u.rent+','+u.nightly+','+u.occ+','+u.furnish)}
  if(rehabMode==='sqft')params.set('rm','sqft');
  var url=window.location.origin+window.location.pathname+'?'+params.toString();
  navigator.clipboard.writeText(url).then(function(){
    var t=$('shareToast');t.classList.add('show');setTimeout(function(){t.classList.remove('show')},2500);
  }).catch(function(){prompt('Copy this link:',url)});
}
$('shareBtn').addEventListener('click',shareAnalysis,false);
$('shareBtn').addEventListener('touchend',function(e){e.preventDefault();shareAnalysis(e)},false);

// ─── Load from URL params ───────────────────────────────────
function loadFromURL(){
  var p=new URLSearchParams(window.location.search);
  if(!p.has('pp'))return false;
  var fields={pp:'purchasePrice',rh:'rehabBudget',arv:'arv',ins:'monthlyInsurance',tx:'monthlyTax',
    sc:'sellCostPct',dp:'downPct',br:'bhRate',bt:'bhTermYears',rr:'refiRate',rl:'refiLtv',
    rt:'refiTermYears',iy:'ioYears',hr:'hmRate',hp:'hmPoints',hl:'hmLtc',ht:'hmTermMonths',
    fh:'flipHoldMonths',fc:'flipHoldCostMo',cc:'closingCostPct',vp:'vacancyPct',mp:'mgmtPct',
    cp:'capexPct',rg:'rentGrowth',ap:'appreciation',sf:'sqft',cs:'costPerSqft'};
  for(var k in fields)if(p.has(k))$(fields[k]).value=p.get(k);
  if(p.has('st'))$('addrStreet').value=p.get('st');
  if(p.has('un'))$('addrUnit').value=p.get('un');
  if(p.has('ci'))$('addrCity').value=p.get('ci');
  if(p.has('sa'))$('addrState').value=p.get('sa');
  if(p.has('zp'))$('addrZip').value=p.get('zp');
  if(p.get('io')==='1'){useIO=true;$('ioToggle').classList.add('on');$('ioFields').style.display='block'}
  if(p.get('hm')==='1'){useHM=true;$('hmToggle').classList.add('on');$('hmFields').classList.add('show')}
  if(p.get('rm')==='sqft'){rehabMode='sqft';document.querySelectorAll('.rehab-opt').forEach(function(b){b.classList.toggle('active',b.getAttribute('data-mode')==='sqft')});$('rehabTotal').style.display='none';$('rehabSqft').style.display='block';updRehab()}
  if(p.has('nu')){numUnits=parseInt(p.get('nu'))||1;units=[];
    for(var i=0;i<numUnits;i++){if(p.has('u'+i)){var parts=p.get('u'+i).split(',');units.push({type:parts[0]||'ltr',rent:parseFloat(parts[1])||1800,nightly:parseFloat(parts[2])||150,occ:parseFloat(parts[3])||70,furnish:parseFloat(parts[4])||0})}else{units.push({type:'ltr',rent:1800,nightly:150,occ:70,furnish:0})}}
    buildCards();
  }
  return true;
}

// ─── Data Persistence ────────────────────────────────────────
var SAVE_KEY='qrea_data_v1';
var saveTimer=null;
function saveToLocal(){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(function(){
    saveUD();
    var data={
      addrStreet:$('addrStreet').value,addrUnit:$('addrUnit').value,addrCity:$('addrCity').value,
      addrState:$('addrState').value,addrZip:$('addrZip').value,
      purchasePrice:$('purchasePrice').value,rehabBudget:$('rehabBudget').value,arv:$('arv').value,
      sqft:$('sqft').value,costPerSqft:$('costPerSqft').value,rehabMode:rehabMode,
      monthlyInsurance:$('monthlyInsurance').value,monthlyTax:$('monthlyTax').value,sellCostPct:$('sellCostPct').value,
      downPct:$('downPct').value,bhRate:$('bhRate').value,bhTermYears:$('bhTermYears').value,
      refiRate:$('refiRate').value,refiLtv:$('refiLtv').value,refiTermYears:$('refiTermYears').value,
      ioYears:$('ioYears').value,useIO:useIO,useHM:useHM,
      hmRate:$('hmRate').value,hmPoints:$('hmPoints').value,hmLtc:$('hmLtc').value,hmTermMonths:$('hmTermMonths').value,
      flipHoldMonths:$('flipHoldMonths').value,flipHoldCostMo:$('flipHoldCostMo').value,
      closingCostPct:$('closingCostPct').value,vacancyPct:$('vacancyPct').value,mgmtPct:$('mgmtPct').value,
      capexPct:$('capexPct').value,rentGrowth:$('rentGrowth').value,appreciation:$('appreciation').value,
      numUnits:numUnits,units:units
    };
    try{localStorage.setItem(SAVE_KEY,JSON.stringify(data))}catch(e){}
    var n=$('saveNotice');n.classList.add('show');setTimeout(function(){n.classList.remove('show')},1500);
  },800);
}
function loadFromLocal(){
  try{
    var raw=localStorage.getItem(SAVE_KEY);if(!raw)return;
    var d=JSON.parse(raw);
    if(d.addrStreet)$('addrStreet').value=d.addrStreet;
    if(d.addrUnit)$('addrUnit').value=d.addrUnit;
    if(d.addrCity)$('addrCity').value=d.addrCity;
    if(d.addrState)$('addrState').value=d.addrState;
    if(d.addrZip)$('addrZip').value=d.addrZip;
    var flds=['purchasePrice','rehabBudget','arv','sqft','costPerSqft','monthlyInsurance','monthlyTax',
      'sellCostPct','downPct','bhRate','bhTermYears','refiRate','refiLtv','refiTermYears','ioYears',
      'hmRate','hmPoints','hmLtc','hmTermMonths','flipHoldMonths','flipHoldCostMo',
      'closingCostPct','vacancyPct','mgmtPct','capexPct','rentGrowth','appreciation'];
    for(var i=0;i<flds.length;i++){if(d[flds[i]]!=null)$(flds[i]).value=d[flds[i]]}
    if(d.rehabMode&&d.rehabMode!==rehabMode){rehabMode=d.rehabMode;
      document.querySelectorAll('.rehab-opt').forEach(function(b){b.classList.toggle('active',b.getAttribute('data-mode')===rehabMode)});
      $('rehabTotal').style.display=rehabMode==='total'?'block':'none';$('rehabSqft').style.display=rehabMode==='sqft'?'block':'none';updRehab()}
    if(d.useIO){useIO=true;$('ioToggle').classList.add('on');$('ioFields').style.display='block'}
    if(d.useHM){useHM=true;$('hmToggle').classList.add('on');$('hmFields').classList.add('show')}
    if(d.numUnits){numUnits=d.numUnits;if(d.units)units=d.units;buildCards()}
  }catch(e){}
}
document.querySelectorAll('input[type="number"],input[type="text"]').forEach(function(inp){inp.addEventListener('input',saveToLocal)});
document.querySelectorAll('.rehab-opt,.type-opt,.tog-btn,.step-btn').forEach(function(btn){btn.addEventListener('click',function(){setTimeout(saveToLocal,100)})});

// ─── Nav Toggle ─────────────────────────────────────────────
$('navToggle').addEventListener('click',function(e){e.preventDefault();$('navLinks').classList.toggle('open')});

// ─── Smooth Scroll ──────────────────────────────────────────
document.querySelectorAll('a[href^="#"]').forEach(function(a){
  a.addEventListener('click',function(e){
    var t=document.querySelector(this.getAttribute('href'));
    if(t){e.preventDefault();t.scrollIntoView({behavior:'smooth'});$('navLinks').classList.remove('open')}
  });
});

// ─── Init ────────────────────────────────────────────────────
var fromURL=loadFromURL();
if(!fromURL)loadFromLocal();
buildCards();
if(fromURL)setTimeout(function(){calculate()},200);
})();
</script>
</body>
</html>
